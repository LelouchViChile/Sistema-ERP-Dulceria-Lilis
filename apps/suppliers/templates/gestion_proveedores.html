{% extends "base.html" %}
{% load static %}
{% block title %}Gestión de Proveedores | Dulcería Lilis ERP{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-md-4">

  <!-- Título -->
  <div class="d-flex align-items-center gap-2 mt-2 mb-3">
    <h4 class="m-0 text-danger fw-bold">
      <i class="bi bi-truck me-2"></i>Gestión de Proveedores
    </h4>
    <div class="flex-grow-1">
      <hr class="border-top border-2 border-danger my-0" />
    </div>
  </div>

  <div class="d-flex justify-content-end align-items-center mb-3 gap-2">
    <form method="get" class="d-flex gap-2">
      <div class="input-group input-group-sm shadow-sm" style="min-width: 280px;">
        <input type="text" name="q" class="form-control border-danger" placeholder="Buscar proveedor..." value="{{ query }}">
        <button type="submit" class="btn btn-danger">
          <i class="bi bi-search"></i>
        </button>
      </div>

      <!-- ======== ZONA A: NO FORMATEAR / NO SELECCIONAR ======== -->
      <!-- prettier-ignore-start -->
      <select name="sort" class="form-select form-select-sm border-danger" onchange="this.form.submit()">
        <option value="id" {% if sort_by == 'id' %}selected{% endif %}>Ordenar por...</option>
        <option value="username" {% if sort_by == 'username' %}selected{% endif %}>RUT/NIF (A-Z)</option>
        <option value="-username" {% if sort_by == '-username' %}selected{% endif %}>RUT/NIF (Z-A)</option>
        <option value="first_name" {% if sort_by == 'first_name' %}selected{% endif %}>Razón Social (A-Z)</option>
      </select>
      <!-- prettier-ignore-end -->
      <!-- ======================================================= -->

      <!-- NUEVO: filtro ver -->
      <select name="ver" class="form-select form-select-sm border-danger" onchange="this.form.submit()">
        <option value="activos" {% if ver == 'activos' %}selected{% endif %}>Sólo activos</option>
        <option value="inactivos" {% if ver == 'inactivos' %}selected{% endif %}>Sólo inactivos</option>
        <option value="todos" {% if ver == 'todos' %}selected{% endif %}>Todos</option>
      </select>

      <a class="btn btn-success btn-sm d-flex align-items-center shadow-sm"
         href="{% url 'gestion_usuarios' %}?q={{ query }}&sort={{ sort_by }}&ver={{ ver }}&export=xlsx">
        <i class="bi bi-file-earmark-excel me-2"></i>Exportar
      </a>
    </form>
  </div>

  <div class="row g-3 align-items-start">

    <!-- Formulario con pestañas -->
    <div class="col-12 col-lg-4 col-xxl-3">
      <div class="card border border-danger shadow-sm h-100">
        <div class="card-body">
          <h6 class="text-danger fw-bold mb-3 d-flex align-items-center">
            <i class="bi bi-person-plus-fill me-2"></i>Nuevo Proveedor
          </h6>

          <form id="form-prov" class="row g-3 needs-validation" novalidate>
            <!-- NAV TABS -->
            <ul class="nav nav-tabs mb-3" id="provTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active text-danger fw-semibold" id="tab-ident" data-bs-toggle="tab"
                        data-bs-target="#pane-ident" type="button" role="tab">Datos Generales</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link text-danger fw-semibold" id="tab-dir" data-bs-toggle="tab"
                        data-bs-target="#pane-dir" type="button" role="tab">Dirección</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link text-danger fw-semibold" id="tab-rel" data-bs-toggle="tab"
                        data-bs-target="#pane-rel" type="button" role="tab">Relación</button>
              </li>
            </ul>

            <!-- CONTENIDO TABS -->
            <div class="tab-content" id="provTabsContent">

              <!-- TAB 1 IDENTIFICACIÓN Y CONTACTO -->
              <div class="tab-pane fade show active" id="pane-ident" role="tabpanel">
                <div class="row g-3">
                  <div class="col-6">
                    <label class="form-label small mb-1">RUT/NIF <span class="text-danger">*</span></label>
                    <input type="text" id="f_rut" class="form-control form-control-sm" autocomplete="off" required>
                    <div class="invalid-feedback">RUT/NIF obligatorio y válido.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Nombre fantasía (opcional)</label>
                    <input type="text" id="f_fantasia" class="form-control form-control-sm" autocomplete="off">
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Razón social <span class="text-danger">*</span></label>
                    <input type="text" id="f_razon" class="form-control form-control-sm" autocomplete="off" required>
                    <div class="invalid-feedback">Razón social obligatoria.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Email <span class="text-danger">*</span></label>
                    <input type="email" id="f_email" class="form-control form-control-sm" autocomplete="off" required>
                    <div class="invalid-feedback">Email obligatorio y válido.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Teléfono <span class="text-danger">*</span></label>
                    <input type="text" id="f_fono" class="form-control form-control-sm" autocomplete="off" required>
                    <div class="invalid-feedback">Teléfono obligatorio y válido.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Sitio web</label>
                    <input type="text" id="f_web" class="form-control form-control-sm" placeholder="https://…" autocomplete="off">
                    <div class="invalid-feedback">Debe comenzar con http:// o https://</div>
                  </div>
                </div>
              </div>

              <!-- TAB 2 DIRECCIÓN Y COMERCIAL -->
              <div class="tab-pane fade" id="pane-dir" role="tabpanel">
                <div class="row g-3">
                  <div class="col-6">
                    <label class="form-label small mb-1">Plazos de pago (días)</label>
                    <input type="number" id="f_plazo" class="form-control form-control-sm" min="0" max="365" step="1" inputmode="numeric">
                    <div class="invalid-feedback">Debe estar entre 0 y 365 días.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Moneda</label>
                    <select id="f_moneda" class="form-select form-select-sm">
                      <option>CLP</option>
                      <option>USD</option>
                      <option>EUR</option>
                    </select>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Descuento (%)</label>
                    <input type="number" id="f_desc" class="form-control form-control-sm" min="0" max="100" step="0.01" inputmode="decimal">
                    <div class="invalid-feedback">Debe estar entre 0% y 100%.</div>
                  </div>
                </div>
              </div>

              <!-- TAB 3 RELACIÓN CON PRODUCTOS -->
              <div class="tab-pane fade" id="pane-rel" role="tabpanel">
                <div class="row g-3">
                  <div class="col-12 d-flex align-items-center gap-2">
                    <input type="checkbox" id="rel_pref" class="form-check-input">
                    <label class="form-label small mb-0" for="rel_pref">Proveedor preferente</label>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Lead time (días)</label>
                    <input type="number" id="rel_lead" class="form-control form-control-sm" min="0" max="365" step="1" inputmode="numeric">
                    <div class="invalid-feedback">Debe estar entre 0 y 365 días.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Costo asociado</label>
                    <input type="number" id="rel_costo" class="form-control form-control-sm" min="0" step="0.01" inputmode="decimal">
                    <div class="invalid-feedback">No puede ser negativo.</div>
                  </div>
                  <div class="col-12">
                    <label class="form-label small mb-1">Producto (buscar por SKU o nombre)</label>
                    <input type="text" id="rel_product_search" class="form-control form-control-sm" placeholder="Ej: DUL-001 o Gomitas…" autocomplete="off">
                    <div class="invalid-feedback">Indique un producto existente (SKU o nombre).</div>
                  </div>
                  <div class="col-12">
                    <button type="button" class="btn btn-sm btn-primary" id="btnGuardarRelacion">Guardar relación</button>
                    <p class="text-muted small mt-2">Usa “Proveedor preferente”, “Lead time (días)” y “Costo asociado” y luego guarda la relación.</p>
                  </div>
                </div>
              </div>

            </div>

            <div class="mt-3 d-flex gap-2">
              <button type="button" class="btn btn-sm btn-danger flex-grow-1" id="btnGuardarProveedor">
                <i class="bi bi-check-lg me-1"></i>Guardar
              </button>
              <button type="button" class="btn btn-sm btn-outline-danger px-3" id="btnLimpiar">
                <i class="bi bi-eraser me-1"></i>Limpiar
              </button>
            </div>

            <div id="provMsg" class="small mt-2"></div>
          </form>
        </div>
      </div>
    </div>

    <!-- Tabla Proveedores -->
    <div class="col-12 col-lg-8 col-xxl-9">
      <div class="card border border-danger shadow-sm h-100">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="m-0">Proveedores</h6>
            <div class="input-group input-group-sm" style="max-width: 320px;">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input type="text" id="provSearch" class="form-control" placeholder="Buscar por RUT/NIF o razón social"
                     autocomplete="off" data-url="{% url 'suppliers:search' %}">
            </div>
          </div>
          <div class="table-responsive" style="max-height: 520px; overflow-y: auto;">
            <table class="table table-striped align-middle text-center mb-0">
              <thead>
                <tr>
                  <th>RUT/NIF</th>
                  <th>Razón social</th>
                  <th>Estado</th>
                  <th>Email</th>
                  <th class="text-center">Acciones</th>
                </tr>
              </thead>
              <tbody id="provTbody">
                {% for p in proveedores %}
                <tr>
                  <td>{{ p.rut }}</td>
                  <td>{{ p.razon_social }}</td>
                  <td>
                    {% if p.estado == "Activo" %}
                      <span class="badge bg-success">ACTIVO</span>
                    {% elif p.estado == "Bloqueado" or p.estado == "Inactivo" %}
                      <span class="badge bg-danger">{{ p.estado|upper }}</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ p.estado|upper }}</span>
                    {% endif %}
                  </td>
                  <td>{{ p.email }}</td>
                  <td>
                    <button class="btn btn-sm btn-warning btnEditarProv" data-id="{{ p.id }}"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-danger btnEliminarProv" data-id="{{ p.id }}"><i class="bi bi-trash"></i></button>
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-muted">Sin resultados</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
(function(){
  const CSRF = (document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)')||[])[2] || '';

  // =====================================================
  // ===============  HELPER FUNCTIONS  ==================
  // =====================================================
  function setInvalid(el, msg){
    if(!el) return;
    const fb = el.parentElement.querySelector('.invalid-feedback');
    if(msg){
      el.classList.add('is-invalid');
      if(fb) fb.textContent = msg;
    } else {
      el.classList.remove('is-invalid');
    }
  }

  function switchToTabOf(element){
    const pane = element.closest('.tab-pane');
    if(pane && !pane.classList.contains('active')){
      const trigger = document.querySelector(`[data-bs-target="#${pane.id}"]`);
      if(trigger) new bootstrap.Tab(trigger).show();
    }
  }

  // =====================================================
  // ===============  VALIDACIÓN GLOBAL  =================
  // =====================================================
  function validateSupplier(){
    let ok = true;
    const campos = document.querySelectorAll('#form-prov input, #form-prov select');
    let primerError = null;

    campos.forEach(el=>{
      const id = el.id;
      const val = el.value.trim();
      let valido = true;
      let msg = '';

      switch(id){
        case 'f_rut':
          valido = /^[0-9kK.\-]{7,20}$/.test(val);
          msg = 'RUT/NIF obligatorio y válido.';
          break;
        case 'f_razon':
          valido = !!val;
          msg = 'Razón social obligatoria.';
          break;
        case 'f_email':
          valido = /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(val);
          msg = 'Email obligatorio y válido.';
          break;
        case 'f_fono':
          valido = /^[0-9+()\-\s]{6,30}$/.test(val);
          msg = 'Teléfono obligatorio y válido.';
          break;
        case 'f_web':
          valido = !val || /^https?:\/\/.+/i.test(val);
          msg = 'Debe comenzar con http:// o https://';
          break;
        case 'f_plazo':
          valido = !val || (Number(val)>=0 && Number(val)<=365);
          msg = 'Debe estar entre 0 y 365 días.';
          break;
        case 'f_desc':
          valido = !val || (Number(val)>=0 && Number(val)<=100);
          msg = 'Debe estar entre 0% y 100%.';
          break;
      }

      if(!valido){
        setInvalid(el,msg);
        if(!primerError) primerError = el;
        ok = false;
      } else setInvalid(el,null);
    });

    if(primerError){
      switchToTabOf(primerError);
      primerError.focus();
    }

    return ok;
  }

  // =====================================================
  // ===============  GUARDAR PROVEEDOR  =================
  // =====================================================
  document.getElementById('btnGuardarProveedor')?.addEventListener('click', async ()=>{
    const msg = document.getElementById('provMsg');
    msg.className='small mt-2';
    msg.textContent='';

    if(!validateSupplier()){
      msg.classList.add('text-danger');
      msg.textContent='Revisa los campos resaltados.';
      return;
    }

    const payload = {
      rut_nif: document.getElementById('f_rut').value.trim(),
      nombre_fantasia: document.getElementById('f_fantasia').value.trim(),
      razon_social: document.getElementById('f_razon').value.trim(),
      email: document.getElementById('f_email').value.trim(),
      telefono: document.getElementById('f_fono').value.trim(),
      sitio_web: document.getElementById('f_web').value.trim(),
      plazos_pago_dias: document.getElementById('f_plazo').value.trim(),
      moneda: document.getElementById('f_moneda').value.trim(),
      descuento_porcentaje: document.getElementById('f_desc').value.trim()
    };

    try{
      const resp = await fetch("{% url 'suppliers:create' %}",{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'X-CSRFToken':CSRF,
          'X-Requested-With':'XMLHttpRequest'
        },
        body: JSON.stringify(payload)
      });
      const data = await resp.json();

      if(!resp.ok || !data.ok){
        msg.classList.add('text-danger');
        msg.textContent = (data.errors && data.errors.__all__) || 'Revisa los campos resaltados.';
        return;
      }

      msg.classList.add('text-success');
      msg.textContent='Proveedor guardado correctamente.';
      setTimeout(()=>location.reload(),1000);
    }catch(err){
      msg.classList.add('text-danger');
      msg.textContent='Error al guardar proveedor.';
      console.error(err);
    }
  });

  // =====================================================
  // ===============  LIMPIAR FORMULARIO  ================
  // =====================================================
  document.getElementById('btnLimpiar')?.addEventListener('click', ()=>{
    document.querySelectorAll('#form-prov input,#form-prov select').forEach(el=>{
      if(el.type==='checkbox') el.checked=false;
      else el.value='';
      el.classList.remove('is-invalid');
    });
    const msg=document.getElementById('provMsg');
    msg.textContent='';
    msg.className='small mt-2 d-none';
  });

  // =====================================================
  // ===============  BUSCADOR + PAGINADOR  ==============
  // =====================================================
  const input=document.getElementById('provSearch');
  const tbody=document.getElementById('provTbody');
  if(input && tbody){
    let ctrl=null, timer=null, currentPage=1;

    async function loadPage(q,page=1){
      if(ctrl) ctrl.abort();
      ctrl = new AbortController();
      try{
        const resp = await fetch(`${input.dataset.url}?q=${encodeURIComponent(q||'')}&page=${page}`,{
          signal: ctrl.signal, headers:{'X-Requested-With':'XMLHttpRequest'}
        });
        if(!resp.ok) throw new Error();
        const data = await resp.json();
        render(data.results||[], data.page_count || 1, data.current_page || 1, q);
      }catch(e){
        render([],1,1,q);
      }
    }

    function render(items,totalPages,current,q){
      if(!items?.length){
        tbody.innerHTML = `<tr><td colspan="5" class="text-muted">Sin resultados</td></tr>`;
        document.getElementById('provPaginator').innerHTML='';
        return;
      }

      tbody.innerHTML = items.map(p=>`
        <tr>
          <td>${p.rut||''}</td>
          <td>${p.razon_social||''}</td>
          <td>${p.estado==='Activo'
              ?'<span class="badge bg-success">ACTIVO</span>'
              :'<span class="badge bg-secondary">'+(p.estado||'').toUpperCase()+'</span>'}</td>
          <td>${p.email||''}</td>
          <td>
            <button class="btn btn-sm btn-warning btnEditarProv" data-id="${p.id}"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-danger btnEliminarProv" data-id="${p.id}"><i class="bi bi-trash"></i></button>
          </td>
        </tr>`).join('');

      // PAGINADOR
      let html='';
      for(let i=1;i<=totalPages;i++){
        html += `<li class="page-item ${i===current?'active':''}">
                   <a class="page-link" href="#" data-page="${i}">${i}</a>
                 </li>`;
      }
      document.getElementById('provPaginator').innerHTML=html;

      tbody.querySelectorAll('.btnEditarProv').forEach(btn=>btn.addEventListener('click',()=>editarProveedor(btn.dataset.id)));
      tbody.querySelectorAll('.btnEliminarProv').forEach(btn=>btn.addEventListener('click',()=>eliminarProveedor(btn.dataset.id)));

      document.querySelectorAll('#provPaginator a').forEach(a=>{
        a.addEventListener('click',e=>{
          e.preventDefault();
          loadPage(q, Number(a.dataset.page));
        });
      });
    }

    input.addEventListener('input',()=>{
      clearTimeout(timer);
      timer=setTimeout(()=>loadPage(input.value.trim(),1),250);
    });
    document.addEventListener('DOMContentLoaded',()=>loadPage('',1));
  }

  // =====================================================
  // ===============  EDITAR PROVEEDOR  ==================
  // =====================================================
  async function editarProveedor(id){
    try{
      const resp = await fetch(`/proveedores/editar/${id}/`,{headers:{'X-Requested-With':'XMLHttpRequest'}});
      if(!resp.ok) throw new Error('No se pudo obtener proveedor');
      const data=await resp.json();

      const {value: formValues} = await Swal.fire({
        title:'Editar Proveedor',
        html:`
          <input id="edit_rut" class="swal2-input" placeholder="RUT/NIF" value="${data.rut_nif||''}">
          <input id="edit_razon" class="swal2-input" placeholder="Razón Social" value="${data.razon_social||''}">
          <input id="edit_email" class="swal2-input" placeholder="Email" value="${data.email||''}">
          <input id="edit_telefono" class="swal2-input" placeholder="Teléfono" value="${data.telefono||''}">
          <input id="edit_web" class="swal2-input" placeholder="Sitio web" value="${data.sitio_web||''}">
        `,
        showCancelButton:true,
        confirmButtonText:'Guardar',
        cancelButtonText:'Cancelar',
        preConfirm:()=>{
          return {
            rut_nif: document.getElementById('edit_rut').value.trim(),
            razon_social: document.getElementById('edit_razon').value.trim(),
            email: document.getElementById('edit_email').value.trim(),
            telefono: document.getElementById('edit_telefono').value.trim(),
            sitio_web: document.getElementById('edit_web').value.trim()
          };
        }
      });

      if(formValues){
        const update = await fetch(`/proveedores/editar/${id}/`,{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'X-CSRFToken':CSRF,
            'X-Requested-With':'XMLHttpRequest'
          },
          body: JSON.stringify(formValues)
        });
        const result=await update.json();
        if(result.status==='ok'){
          Swal.fire({icon:'success',title:'Proveedor actualizado',timer:1200,showConfirmButton:false})
            .then(()=>location.reload());
        }else{
          Swal.fire({icon:'error',title:'Error',text:result.message||'Error al actualizar proveedor.'});
        }
      }
    }catch(err){
      Swal.fire({icon:'error',title:'Error',text:'No se pudo obtener proveedor'});
      console.error(err);
    }
  }

  // =====================================================
  // ===============  ELIMINAR PROVEEDOR  ================
  // =====================================================
  async function eliminarProveedor(id){
    const confirm = await Swal.fire({
      title:'¿Eliminar proveedor?',
      text:'Esta acción no se puede revertir',
      icon:'warning',
      showCancelButton:true,
      confirmButtonColor:'#d33',
      cancelButtonColor:'#3085d6',
      confirmButtonText:'Sí, eliminar',
      cancelButtonText:'Cancelar'
    });

    if(confirm.isConfirmed){
      try{
        const resp=await fetch(`/proveedores/eliminar/${id}/`,{
          method:'POST',
          headers:{'X-CSRFToken':CSRF,'X-Requested-With':'XMLHttpRequest'}
        });
        const data=await resp.json();
        if(data.status==='ok'){
          Swal.fire('¡Eliminado!',data.message,'success').then(()=>location.reload());
        }else{
          Swal.fire({icon:'error',title:'Error',text:data.message||'No se pudo eliminar.'});
        }
      }catch(err){
        Swal.fire({icon:'error',title:'Error',text:'Error al eliminar proveedor.'});
        console.error(err);
      }
    }
  }

  window.editarProveedor = editarProveedor;
  window.eliminarProveedor = eliminarProveedor;
})();
</script>
{% endblock %}