{% extends "base.html" %}
{% block title %}Proveedores{% endblock %}

{% block content %}
<h5 class="fw-bold mt-3">Gestión Proveedores</h5>
<div class="card shadow-sm mb-4">
    <div class="card-header pb-1">
        <h6>Formulario de Proveedor</h6>
        <ul class="nav nav-tabs mt-2" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#tab1">Ingrese datos del proveedor</a>
            </li>
        </ul>
    </div>
    <div class="card-body">
        <div class="tab-content">
            <div id="tab1" class="tab-pane fade show active">
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label">RUT/NIF</label>
                        <input type="text" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Razón social</label>
                        <input type="text" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Nombre fantasía (opcional)</label>
                        <input type="text" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Teléfono</label>
                        <input type="text" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Sitio web (opcional)</label>
                        <input type="text" class="form-control">
                    </div>
                </div>
                <div class="mt-3">
                    <button type="button" class="btn btn-primary" onclick="guardarProveedor()">Guardar</button>
                    <button type="button" class="btn btn-light">Limpiar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>Proveedores</div>
        <button class="btn btn-outline-secondary btn-sm">Exportar a Excel</button>
    </div>
    <div class="card-body">
        <div class="row mb-2">
            <div class="col-sm-4">
                <input type="text" class="form-control" placeholder="Buscar por RUT/NIF o razón social">
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped align-middle text-center">
                <thead>
                    <tr>
                        <th>RUT/NIF</th>
                        <th>Razón social</th>
                        <th>Estado</th>
                        <th>Email</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in proveedores %}
                    <tr>
                        <td>{{ p.rut }}</td>
                        <td>{{ p.razon_social }}</td>
                        <td>
                            {% if p.estado == "Activo" %}
                            <span class="badge bg-success">ACTIVO</span>
                            {% elif p.estado == "Bloqueado" or p.estado == "Inactivo" %}
                            <span class="badge bg-danger">{{ p.estado|upper }}</span>
                            {% endif %}
                        </td>
                        <td>{{ p.email }}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editarProveedor('{{ p.rut }}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="eliminarProveedor('{{ p.rut }}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function guardarProveedor() {
        Swal.fire({
            title: 'Guardar datos',
            text: '¿Deseas guardar los datos del proveedor?',
            icon: 'info',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#c11b17',
            confirmButtonText: 'Sí, guardar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire('Proveedor guardado', 'Los datos fueron almacenados correctamente', 'success');
            }
        });
    }

    function editarProveedor(rut) {
        Swal.fire({
            title: '¿Estás seguro?',
            text: 'Vas a editar el proveedor ' + rut,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#c11b17',
            confirmButtonText: 'Sí, editar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire('Redirigiendo...', '', 'info');
            }
        });
    }

    function eliminarProveedor(rut) {
        Swal.fire({
            title: 'Advertencia',
            text: '¿Quieres eliminar el proveedor ' + rut + '? Esta acción es irreversible.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#c11b17',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire('Eliminado', 'Proveedor ' + rut + ' eliminado (simulado)', 'success');
            }
        });
    }
</script>

<!-- ============== AGREGADO: SweetAlert2 + Validaciones en español ============== -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    (function () {
        // Busca campo según su etiqueta
        function campo(etiqueta) {
            const lbls = document.querySelectorAll('label.form-label');
            etiqueta = etiqueta.toLowerCase();
            for (const l of lbls) {
                const txt = l.textContent.toLowerCase();
                if (txt.includes(etiqueta)) {
                    const cont = l.closest('div');
                    if (cont) { const inp = cont.querySelector('input,select'); if (inp) return inp; }
                }
            }
            return null;
        }

        // Validaciones específicas
        function validarProveedor() {
            const errores = [];
            const rut = campo('RUT');
            const razon = campo('Razón social');
            const email = campo('Email');
            const fono = campo('Teléfono');
            const web = campo('Sitio web');

            const rutVal = (rut?.value || '').trim();
            const razonVal = (razon?.value || '').trim();
            const emailVal = (email?.value || '').trim();
            const fonoVal = (fono?.value || '').trim();
            const webVal = (web?.value || '').trim();

            if (!rutVal) errores.push('El campo “RUT/NIF” es obligatorio.');
            else if (!/^[0-9kK\.\-]{7,20}$/.test(rutVal)) errores.push('Formato de “RUT/NIF” inválido.');

            if (!razonVal) errores.push('El campo “Razón social” es obligatorio.');

            if (!emailVal) errores.push('El campo “Email” es obligatorio.');
            else if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(emailVal)) errores.push('Formato de “Email” inválido.');

            if (fonoVal && !/^[0-9+()\-\s]{6,30}$/.test(fonoVal)) errores.push('Formato de “Teléfono” inválido.');

            if (webVal && !/^https?:\/\/.+/i.test(webVal)) errores.push('La “Sitio web” debe comenzar con http:// o https://');

            return errores;
        }

        // Guardamos la referencia del original
        const _guardar = window.guardarProveedor;
        window.guardarProveedor = function () {
            const errs = validarProveedor();
            if (errs.length) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Revisa el formulario',
                    html: '<ul style="text-align:left;margin-left:1rem;">' + errs.map(e => `<li>${e}</li>`).join('') + '</ul>',
                    confirmButtonText: 'Entendido'
                });
                return;
            }
            _guardar && _guardar();
        };
    })();
</script>
<!-- ============== /AGREGADO ============== -->
{% endblock %}