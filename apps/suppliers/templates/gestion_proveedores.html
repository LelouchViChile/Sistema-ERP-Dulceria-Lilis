{% extends "base.html" %}
{% load static %}
{% block title %}Proveedores{% endblock %}

{% block content %}
<h5 class="fw-bold mt-3">Gestión Proveedores</h5>

<div class="card shadow-sm mb-4">
  <div class="card-header pb-1">
    <h6>Formulario de Proveedor</h6>

    <ul class="nav nav-tabs mt-2" role="tablist" id="provTabs">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#tab-ident" role="tab">
          1. Identificación y contacto
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#tab-dir" role="tab">
          2. Dirección y comercial
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#tab-rel" role="tab" id="tabRelBtn">
          3. Relación con productos
        </a>
      </li>
    </ul>
  </div>

  <div class="card-body">
    <div class="tab-content">
      <!-- ✅ TAB 1 -->
      <div class="tab-pane fade show active" id="tab-ident" role="tabpanel">
        <div class="row g-2">
          <div class="col-md-3">
            <label class="form-label">RUT/NIF</label>
            <input type="text" class="form-control" id="f_rut" autocomplete="off">
            <div class="invalid-feedback">RUT/NIF obligatorio y válido.</div>
          </div>
          <div class="col-md-3">
            <label class="form-label">Nombre fantasía (opcional)</label>
            <input type="text" class="form-control" id="f_fantasia" autocomplete="off">
          </div>
          <div class="col-md-6">
            <label class="form-label">Razón social</label>
            <input type="text" class="form-control" id="f_razon" autocomplete="off">
            <div class="invalid-feedback">Razón social obligatoria.</div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="f_email" autocomplete="off">
            <div class="invalid-feedback">Email obligatorio y válido.</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Teléfono</label>
            <input type="text" class="form-control" id="f_fono" autocomplete="off">
            <div class="invalid-feedback">Teléfono obligatorio y válido.</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Sitio web</label>
            <input type="text" class="form-control" id="f_web" placeholder="https://…" autocomplete="off">
            <div class="invalid-feedback">Debe comenzar con http:// o https://</div>
          </div>
        </div>
      </div>

      <!-- ✅ TAB 2 -->
      <div class="tab-pane fade" id="tab-dir" role="tabpanel">
        <div class="row g-2">
          <h6 class="fw-bold mt-2">Condiciones comerciales</h6>

          <div class="col-md-4">
            <label class="form-label">Plazos de pago (días)</label>
            <input type="number" class="form-control num-no-neg" min="0" max="365" step="1" inputmode="numeric" id="f_plazo">
            <div class="invalid-feedback">Debe estar entre 0 y 365 días.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Moneda</label>
            <select class="form-control" id="f_moneda">
              <option>CLP</option>
              <option>USD</option>
              <option>EUR</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Descuento (%)</label>
            <input type="number" class="form-control num-no-neg" min="0" max="100" step="0.01" inputmode="decimal" id="f_desc">
            <div class="invalid-feedback">Debe estar entre 0% y 100%.</div>
          </div>
        </div>
      </div>

      <!-- ✅ TAB 3 -->
      <div class="tab-pane fade" id="tab-rel" role="tabpanel">
        <h6 class="fw-bold">Relación con productos</h6>

        <div class="row g-2">
          <div class="col-md-4 d-flex align-items-center">
            <label class="form-label mb-0">Proveedor preferente</label>
            <input type="checkbox" class="form-check-input ms-2" id="rel_pref">
          </div>

          <div class="col-md-4">
            <label class="form-label">Lead time (días)</label>
            <input type="number" class="form-control num-no-neg" min="0" max="365" step="1" inputmode="numeric" id="rel_lead">
            <div class="invalid-feedback">Debe estar entre 0 y 365 días.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Costo asociado</label>
            <input type="number" class="form-control num-no-neg" min="0" step="0.01" inputmode="decimal" id="rel_costo">
            <div class="invalid-feedback">No puede ser negativo.</div>
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-md-8">
            <label class="form-label">Producto (buscar por SKU o nombre)</label>
            <input type="text" class="form-control" id="rel_product_search" placeholder="Ej: DUL-001 o Gomitas…" autocomplete="off">
            <div class="invalid-feedback">Indique un producto existente (SKU o nombre).</div>
          </div>
          <div class="col-md-4">
            <label class="form-label d-none d-md-block">&nbsp;</label>
            <button type="button" class="btn btn-primary w-100" id="btnGuardarRelacion">Guardar relación</button>
          </div>
        </div>

        <p class="text-muted small mt-2">
          Usa “Proveedor preferente”, “Lead time (días)” y “Costo asociado” y luego guarda la relación.
        </p>
      </div>
    </div>

    <div class="mt-3 d-flex align-items-center gap-3">
      <button type="button" class="btn btn-primary" id="btnGuardarProveedor">Guardar</button>
      <button type="button" class="btn btn-light" id="btnLimpiar">Limpiar</button>
      <span id="provMsg" class="small d-none"></span>
    </div>
  </div>
</div>

<!-- ================= Tabla de Proveedores ================= -->
<div class="card shadow-sm mb-4">
  <div class="card-header d-flex justify-content-between align-items-center gap-2">
    <div>Proveedores</div>
    <div class="input-group input-group-sm" style="max-width: 320px;">
      <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input type="text" class="form-control" id="provSearch"
             placeholder="Buscar por RUT/NIF o razón social"
             autocomplete="off"
             data-url="{% url 'suppliers:search' %}">
    </div>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped align-middle text-center">
        <thead>
          <tr>
            <th>RUT/NIF</th>
            <th>Razón social</th>
            <th>Estado</th>
            <th>Email</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody id="provTbody">
          {% for p in proveedores %}
          <tr>
            <td>{{ p.rut }}</td>
            <td>{{ p.razon_social }}</td>
            <td>
              {% if p.estado == "Activo" %}
                <span class="badge bg-success">ACTIVO</span>
              {% elif p.estado == "Bloqueado" or p.estado == "Inactivo" %}
                <span class="badge bg-danger">{{ p.estado|upper }}</span>
              {% else %}
                <span class="badge bg-secondary">{{ p.estado|upper }}</span>
              {% endif %}
            </td>
            <td>{{ p.email }}</td>
            <td>
              <button class="btn btn-sm btn-warning"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-danger"><i class="bi bi-trash"></i></button>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="text-muted">Sin resultados</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ====== Relaciones proveedor–producto (OCULTO al inicio) ====== -->
<div class="card shadow-sm d-none" id="relCard">
  <div class="card-header d-flex align-items-center gap-2">
    <div class="me-auto">Relaciones proveedor–producto</div>

    <div class="input-group input-group-sm" style="max-width: 360px;">
      <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input type="text" class="form-control" id="relSearch"
             placeholder="Buscar por RUT/NIF, razón social, SKU o producto…"
             autocomplete="off"
             data-url="{% url 'suppliers:relations_search' %}">
    </div>

    <a class="btn btn-outline-secondary btn-sm ms-2" id="relExportBtn"
       href="{% url 'suppliers:relations_export' %}">
      Exportar a Excel
    </a>
  </div>

  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-striped align-middle text-center">
        <thead>
          <tr>
            <th>ID</th>
            <th>Proveedor</th>
            <th>RUT/NIF</th>
            <th>Producto</th>
            <th>SKU</th>
            <th>Preferente</th>
            <th>Lead time (d)</th>
            <th>Costo</th>
          </tr>
        </thead>
        <tbody id="relTbody">
          <tr><td colspan="8" class="text-muted">Escribe para buscar…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- =================== JS (validación + AJAX) =================== -->
<script>
  // CSRF desde cookie
  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const CSRF = getCookie('csrftoken');

  // Bloquear negativos
  document.querySelectorAll('.num-no-neg').forEach(el => {
    el.addEventListener('keydown', (ev) => {
      if (['e','E','+','-'].includes(ev.key)) ev.preventDefault();
    });
    el.addEventListener('input', () => {
      const min = Number(el.getAttribute('min') ?? 0);
      const val = Number(el.value);
      if (Number.isFinite(val) && val < min) el.value = min;
    });
  });

  // Helper de error inline
  function setInvalid(el, msg) {
    if (!el) return;
    const fb = el.parentElement.querySelector('.invalid-feedback');
    if (msg) {
      el.classList.add('is-invalid');
      if (fb) fb.textContent = msg;
    } else {
      el.classList.remove('is-invalid');
    }
  }

  // Validaciones front rápidas
  function basicSupplierFrontValidate() {
    let ok = true;

    const rut = document.getElementById('f_rut');
    const razon = document.getElementById('f_razon');
    const email = document.getElementById('f_email');
    const fono = document.getElementById('f_fono');
    const web  = document.getElementById('f_web');
    const plazo = document.getElementById('f_plazo');
    const desc  = document.getElementById('f_desc');

    // RUT
    const rutVal = rut.value.trim();
    if (!/^[0-9kK.\-]{7,20}$/.test(rutVal)) {
      setInvalid(rut, 'RUT/NIF obligatorio y válido.');
      ok = false;
    } else setInvalid(rut, null);

    // Razón
    if (!razon.value.trim()) { setInvalid(razon, 'Razón social obligatoria.'); ok = false; }
    else setInvalid(razon, null);

    // Email
    if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email.value.trim())) {
      setInvalid(email, 'Email obligatorio y válido.');
      ok = false;
    } else setInvalid(email, null);

    // Teléfono (OBLIGATORIO)
    const fonoVal = fono.value.trim();
    if (!/^[0-9+()\-\s]{6,30}$/.test(fonoVal)) {
      setInvalid(fono, 'Teléfono obligatorio y válido.');
      ok = false;
    } else setInvalid(fono, null);

    // Web (opcional, si viene que sea http/https)
    const webVal = web.value.trim();
    if (webVal && !/^https?:\/\/.+/i.test(webVal)) {
      setInvalid(web, 'Debe comenzar con http:// o https://');
      ok = false;
    } else setInvalid(web, null);

    // Plazo 0-365
    const plazoNum = Number(plazo.value || '0');
    if (!Number.isFinite(plazoNum) || plazoNum < 0 || plazoNum > 365) {
      setInvalid(plazo, 'Debe estar entre 0 y 365 días.');
      ok = false;
    } else setInvalid(plazo, null);

    // Descuento 0-100
    const descNum = Number(desc.value || '0');
    if (!Number.isFinite(descNum) || descNum < 0 || descNum > 100) {
      setInvalid(desc, 'Debe estar entre 0% y 100%.');
      ok = false;
    } else setInvalid(desc, null);

    return ok;
  }

  function basicRelationFrontValidate() {
    let ok = true;
    const rut = document.getElementById('f_rut');
    const prod = document.getElementById('rel_product_search');
    const lead = document.getElementById('rel_lead');
    const costo = document.getElementById('rel_costo');

    if (!rut.value.trim()) { setInvalid(rut, 'Debe indicar RUT/NIF del proveedor.'); ok = false; }
    else setInvalid(rut, null);

    if (!prod.value.trim()) { setInvalid(prod, 'Indique un producto (SKU o nombre).'); ok = false; }
    else setInvalid(prod, null);

    const leadNum = Number(lead.value || '0');
    if (!Number.isFinite(leadNum) || leadNum < 0 || leadNum > 365) {
      setInvalid(lead, 'Debe estar entre 0 y 365 días.');
      ok = false;
    } else setInvalid(lead, null);

    const costoNum = Number(costo.value || '0');
    if (!Number.isFinite(costoNum) || costoNum < 0) {
      setInvalid(costo, 'No puede ser negativo.');
      ok = false;
    } else setInvalid(costo, null);

    return ok;
  }

  // -------- Guardar Proveedor (AJAX) --------
  const btnGuardar = document.getElementById('btnGuardarProveedor');
  const provMsg = document.getElementById('provMsg');

  btnGuardar?.addEventListener('click', async () => {
    provMsg.className = 'small d-none';
    provMsg.textContent = '';

    if (!basicSupplierFrontValidate()) {
      provMsg.className = 'small text-danger';
      provMsg.textContent = 'Revisa los campos resaltados.';
      return;
    }

    const payload = {
      rut_nif: document.getElementById('f_rut').value.trim(),
      nombre_fantasia: document.getElementById('f_fantasia').value.trim(),
      razon_social: document.getElementById('f_razon').value.trim(),
      email: document.getElementById('f_email').value.trim(),
      telefono: document.getElementById('f_fono').value.trim(),
      sitio_web: document.getElementById('f_web').value.trim(),
      plazos_pago_dias: document.getElementById('f_plazo').value.trim(),
      moneda: document.getElementById('f_moneda').value.trim(),
      descuento_porcentaje: document.getElementById('f_desc').value.trim(),
    };

    const resp = await fetch("{% url 'suppliers:create' %}", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF, 'X-Requested-With': 'XMLHttpRequest' },
      body: JSON.stringify(payload)
    });

    const data = await resp.json();

    if (!resp.ok || !data.ok) {
      const errs = (data && data.errors) || {};
      if (errs.rut_nif) setInvalid(document.getElementById('f_rut'), errs.rut_nif);
      if (errs.razon_social) setInvalid(document.getElementById('f_razon'), errs.razon_social);
      if (errs.email) setInvalid(document.getElementById('f_email'), errs.email);
      if (errs.telefono) setInvalid(document.getElementById('f_fono'), errs.telefono || 'Teléfono obligatorio y válido.');
      if (errs.sitio_web) setInvalid(document.getElementById('f_web'), errs.sitio_web);
      if (errs.plazos_pago_dias) setInvalid(document.getElementById('f_plazo'), errs.plazos_pago_dias);
      if (errs.descuento_porcentaje) setInvalid(document.getElementById('f_desc'), errs.descuento_porcentaje);

      provMsg.className = 'small text-danger';
      provMsg.textContent = errs.__all__ || 'Revisa los campos resaltados.';
      return;
    }

    provMsg.className = 'small text-success';
    provMsg.textContent = 'Proveedor guardado correctamente.';
  });

  // Limpiar
  document.getElementById('btnLimpiar')?.addEventListener('click', () => {
    document.querySelectorAll('input,select').forEach(el => {
      if (el.type === 'checkbox') el.checked = false; else el.value = '';
      el.classList.remove('is-invalid');
    });
    provMsg.className = 'small d-none';
    provMsg.textContent = '';
  });

  // -------- Mostrar/ocultar bloque de Relaciones --------
  const relCard = document.getElementById('relCard');
  const tabRelBtn = document.getElementById('tabRelBtn');
  tabRelBtn?.addEventListener('shown.bs.tab', () => {
    relCard?.classList.remove('d-none');
  });
  document.getElementById('provTabs')?.addEventListener('shown.bs.tab', (e) => {
    if (e.target.getAttribute('href') !== '#tab-rel') {
      relCard?.classList.add('d-none');
    }
  });

  // -------- Guardar relación (AJAX) --------
  document.getElementById('btnGuardarRelacion')?.addEventListener('click', async () => {
    if (!basicRelationFrontValidate()) return;

    const payload = {
      rut_nif: document.getElementById('f_rut').value.trim(),
      sku_or_name: document.getElementById('rel_product_search').value.trim(),
      preferente: document.getElementById('rel_pref').checked,
      lead_time_dias: document.getElementById('rel_lead').value.trim(),
      costo: document.getElementById('rel_costo').value.trim(),
      minimo_lote: 0,
      descuento_porcentaje: document.getElementById('f_desc').value.trim() || 0
    };

    const resp = await fetch("{% url 'suppliers:relations_create' %}", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF, 'X-Requested-With': 'XMLHttpRequest' },
      body: JSON.stringify(payload)
    });

    const data = await resp.json();

    if (!resp.ok || !data.ok) {
      const errs = (data && data.errors) || {};
      if (errs.rut_nif) setInvalid(document.getElementById('f_rut'), errs.rut_nif);
      if (errs.sku_or_name) setInvalid(document.getElementById('rel_product_search'), errs.sku_or_name);
      if (errs.lead_time_dias) setInvalid(document.getElementById('rel_lead'), errs.lead_time_dias);
      if (errs.costo) setInvalid(document.getElementById('rel_costo'), errs.costo);
      return;
    }

    const btn = document.getElementById('btnGuardarRelacion');
    const old = btn.textContent;
    btn.textContent = 'Guardado ✓';
    setTimeout(() => btn.textContent = old, 1200);
  });

  // -------- Buscador AJAX Proveedores (10) --------
  (function(){
    const input = document.getElementById('provSearch');
    const tbody = document.getElementById('provTbody');
    if (!input || !tbody) return;

    const url = input.dataset.url;
    let ctrl = null, t = null;

    function render(items){
      if (!items || !items.length) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-muted">Sin resultados</td></tr>`;
        return;
      }
      tbody.innerHTML = items.map(p => `
        <tr>
          <td>${p.rut ?? ''}</td>
          <td>${p.razon_social ?? ''}</td>
          <td>${
            (p.estado ?? '').toUpperCase() === 'ACTIVO'
            ? '<span class="badge bg-success">ACTIVO</span>'
            : '<span class="badge bg-secondary">'+(p.estado ?? '').toUpperCase()+'</span>'
          }</td>
          <td>${p.email ?? ''}</td>
          <td>
            <button class="btn btn-sm btn-warning"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-danger"><i class="bi bi-trash"></i></button>
          </td>
        </tr>
      `).join('');
    }

    async function search(q){
      if (ctrl) ctrl.abort();
      ctrl = new AbortController();
      const params = new URLSearchParams({ q: q || '' });
      const resp = await fetch(`${url}?${params.toString()}`, {
        signal: ctrl.signal, headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      if (!resp.ok) { render([]); return; }
      const data = await resp.json();
      render(data.results || []);
    }

    input.addEventListener('input', () => {
      clearTimeout(t);
      t = setTimeout(() => search(input.value.trim()).catch(()=>render([])), 250);
    });

    // AUTO-CARGA INICIAL: llena la tabla con los primeros 10 de BD
    document.addEventListener('DOMContentLoaded', () => {
      search('').catch(()=>render([]));
    });
  })();

  // -------- Buscador AJAX Relaciones (10) + Export sync --------
  (function(){
    const input = document.getElementById('relSearch');
    const exportBtn = document.getElementById('relExportBtn');
    const tbody = document.getElementById('relTbody');
    if (!input || !tbody) return;

    const url = input.dataset.url;
    let ctrl = null, t = null;

    function render(items){
      if (!items || !items.length) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-muted">Sin resultados</td></tr>`;
        return;
      }
      tbody.innerHTML = items.map(r => `
        <tr>
          <td>${r.id ?? ''}</td>
          <td>${r.proveedor ?? ''}</td>
          <td>${r.rut ?? ''}</td>
          <td>${r.producto ?? ''}</td>
          <td>${r.sku ?? ''}</td>
          <td>${r.preferente ? 'Sí' : 'No'}</td>
          <td>${r.lead_time ?? 0}</td>
          <td>${r.costo ?? 0}</td>
        </tr>
      `).join('');
    }

    async function search(q){
      if (ctrl) ctrl.abort();
      ctrl = new AbortController();
      const params = new URLSearchParams({ q: q || '' });
      const resp = await fetch(`${url}?${params.toString()}`, {
        signal: ctrl.signal, headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      if (!resp.ok) { render([]); return; }
      const data = await resp.json();
      render(data.results || []);
    }

    input.addEventListener('input', () => {
      clearTimeout(t);
      const q = input.value.trim();
      const base = exportBtn.getAttribute('href').split('?')[0];
      exportBtn.setAttribute('href', q ? `${base}?q=${encodeURIComponent(q)}` : base);
      t = setTimeout(() => search(q).catch(()=>render([])), 250);
    });

    // AUTO-CARGA INICIAL: mostrar relaciones ni bien se muestre el bloque
    document.addEventListener('DOMContentLoaded', () => {
      // precarga datos para que al abrir la pestaña ya estén listos
      search('').catch(()=>render([]));
      // también alinear el botón Exportar sin filtro
      const base = exportBtn.getAttribute('href').split('?')[0];
      exportBtn.setAttribute('href', base);
    });
  })();
</script>
{% endblock %}
