{% extends "base.html" %}
{% load static %}
{% block title %}Gesti√≥n de Productos | Dulcer√≠a Lilis ERP{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-md-4">

  <!-- T√≠tulo -->
  <div class="d-flex align-items-center gap-2 mt-2 mb-3">
    <h4 class="m-0 text-danger fw-bold">
      <i class="bi bi-box-seam-fill me-2"></i>Gesti√≥n de Productos
    </h4>
    <div class="flex-grow-1">
      <hr class="border-top border-2 border-danger my-0" />
    </div>
  </div>

  <!-- üîç BUSCADOR Y ORDEN (MODO TRANSACCIONES) -->
  <div class="d-flex justify-content-end align-items-center mb-3 gap-2">
    <form method="get" action="{% url 'products:list' %}" class="d-flex gap-2" data-live="search">
      <div class="input-group input-group-sm shadow-sm" style="min-width: 280px;">
        <input type="search" name="q" class="form-control border-danger"
               placeholder="Buscar por ID / SKU / Nombre / Categor√≠a / Stock"
               value="{{ query|default:'' }}" autocomplete="off" inputmode="search">
        <button type="submit" class="btn btn-danger">
          <i class="bi bi-search"></i>
        </button>
      </div>

      <select name="sort" class="form-select form-select-sm border-danger" onchange="this.form.dispatchEvent(new Event('submit',{cancelable:true}))">
        <option value="sku" {% if sort_by == 'sku' %}selected{% endif %}>SKU</option>
        <option value="nombre" {% if sort_by == 'nombre' %}selected{% endif %}>Nombre (A-Z)</option>
        <option value="-nombre" {% if sort_by == '-nombre' %}selected{% endif %}>Nombre (Z-A)</option>
        <option value="categoria" {% if sort_by == 'categoria' %}selected{% endif %}>Categor√≠a (A-Z)</option>
        <option value="-categoria" {% if sort_by == '-categoria' %}selected{% endif %}>Categor√≠a (Z-A)</option>
        <option value="stock" {% if sort_by == 'stock' %}selected{% endif %}>Stock</option>
        <option value="id" {% if sort_by == 'id' %}selected{% endif %}>ID</option>
      </select>

      <a class="btn btn-success btn-sm d-flex align-items-center shadow-sm"
         href="{% url 'products:list' %}?q={{ query }}&sort={{ sort_by }}&export=xlsx">
        <i class="bi bi-file-earmark-excel me-2"></i>Exportar
      </a>
    </form>
  </div>

  <div class="row g-3 align-items-start">
    <!-- Formulario con pesta√±as -->
    <div class="col-12 col-lg-4 col-xxl-3">
      <div class="card border border-danger shadow-sm h-100">
        <div class="card-body">
          <h6 class="text-danger fw-bold mb-3 d-flex align-items-center">
            <i class="bi bi-plus-circle-fill me-2"></i>Nuevo Producto
          </h6>

          <form id="form-prod" method="post" action="{% url 'products:crear' %}" class="row g-3 needs-validation" novalidate>
            {% csrf_token %}
            <!-- NAV TABS -->
            <ul class="nav nav-tabs mb-3" id="prodTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active text-danger fw-semibold" id="tab-datos" data-bs-toggle="tab"
                        data-bs-target="#pane-datos" type="button" role="tab">Datos Generales</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link text-danger fw-semibold" id="tab-inv" data-bs-toggle="tab"
                        data-bs-target="#pane-inv" type="button" role="tab">Inventario</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link text-danger fw-semibold" id="tab-img" data-bs-toggle="tab"
                        data-bs-target="#pane-img" type="button" role="tab">Multimedia</button>
              </li>
            </ul>

            <div class="tab-content" id="prodTabsContent">
              <!-- DATOS GENERALES -->
              <div class="tab-pane fade show active" id="pane-datos" role="tabpanel">
                <div class="row g-3">
                  <div class="col-6">
                    <label class="form-label small mb-1">SKU</label>
                    <input type="text" name="sku" class="form-control form-control-sm" required>
                    <div class="invalid-feedback">El SKU es obligatorio.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Nombre</label>
                    <input type="text" name="nombre" class="form-control form-control-sm" required>
                    <div class="invalid-feedback">El nombre es obligatorio.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Categor√≠a</label>
                    <select name="categoria" class="form-select form-select-sm" required>
                      <option value="">Seleccione...</option>
                      {% for cat in categorias %}
                      <option value="{{ cat.id }}">{{ cat.nombre }}</option>
                      {% endfor %}
                    </select>
                    <div class="invalid-feedback">Selecciona una categor√≠a.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Descripci√≥n</label>
                    <textarea name="descripcion" class="form-control form-control-sm" rows="2" required></textarea>
                    <div class="invalid-feedback">La descripci√≥n es obligatoria.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Precio Compra</label>
                    <input type="number" name="precio_compra" class="form-control form-control-sm" step="0.01" min="0" required>
                    <div class="invalid-feedback">El precio de compra es obligatorio.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Precio Venta</label>
                    <input type="number" name="precio_venta" class="form-control form-control-sm" step="0.01" min="0" required>
                    <div class="invalid-feedback">El precio de venta es obligatorio.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Unidad de Medida</label>
                    <select name="uom" class="form-select form-select-sm" required>
                      <option value="">Seleccione...</option>
                      {% for code, name in uom_choices %}
                      <option value="{{ code }}">{{ name }}</option>
                      {% endfor %}
                    </select>
                    <div class="invalid-feedback">La unidad de medida es obligatoria.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Marca</label>
                    <input type="text" name="marca" class="form-control form-control-sm" required>
                    <div class="invalid-feedback">La marca es obligatoria.</div>
                  </div>
                </div>
              </div>

              <!-- INVENTARIO -->
              <div class="tab-pane fade" id="pane-inv" role="tabpanel">
                <div class="row g-3">
                  <div class="col-6">
                    <label class="form-label small mb-1">Stock M√≠nimo</label>
                    <input type="number" name="stock_min" class="form-control form-control-sm" min="0" step="1" inputmode="numeric" required>
                    <div class="invalid-feedback">El stock m√≠nimo es obligatorio.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Stock M√°ximo</label>
                    <input type="number" name="stock_max" class="form-control form-control-sm" min="0" step="1" inputmode="numeric" required>
                    <div class="invalid-feedback">El stock m√°ximo es obligatorio.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Ubicaci√≥n en Bodega</label>
                    <select name="ubicacion" class="form-select form-select-sm" required>
                      <option value="">Seleccione...</option>
                      {% for bodega in bodegas %}
                      <option value="{{ bodega.id }}">{{ bodega.nombre }}</option>
                      {% endfor %}
                    </select>
                    <div class="invalid-feedback">La ubicaci√≥n es obligatoria.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Proveedor Principal</label>
                    <input type="text" name="proveedor" class="form-control form-control-sm" required>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">√öltima Entrada</label>
                    <input type="date" name="ultima_entrada" class="form-control form-control-sm" readonly>
                    <div class="form-text small">Se registrar√° la fecha actual.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Estado</label>
                    <select name="estado" class="form-select form-select-sm" required>
                      <option value="Activo">Activo</option>
                      <option value="Inactivo">Inactivo</option>
                      <option value="Descontinuado">Descontinuado</option>
                    </select>
                    <div class="invalid-feedback">El estado es obligatorio.</div>
                  </div>
                </div>
              </div>

              <!-- MULTIMEDIA -->
              <div class="tab-pane fade" id="pane-img" role="tabpanel">
                <div class="row g-3">
                  <div class="col-12">
                    <label class="form-label small mb-1">Imagen del Producto</label>
                    <input type="file" name="imagen" class="form-control form-control-sm" required>
                    <div class="invalid-feedback">La imagen es obligatoria.</div>
                  </div>
                  <div class="col-12">
                    <label class="form-label small mb-1">C√≥digo de Barras</label>
                    <input type="text" name="codigo_barras" class="form-control form-control-sm" required>
                    <div class="invalid-feedback">El c√≥digo de barras es obligatorio.</div>
                  </div>
                  <div class="col-12">
                    <label class="form-label small mb-1">Notas Internas</label>
                    <textarea name="notas" class="form-control form-control-sm" rows="2" required></textarea>
                    <div class="invalid-feedback">Las notas son obligatorias.</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-3 d-flex gap-2">
              <button type="button" id="btnGuardarProducto" class="btn btn-sm btn-danger flex-grow-1">
                <i class="bi bi-check-lg me-1"></i>Guardar
              </button>
              <button type="button" id="btnLimpiar" class="btn btn-sm btn-outline-danger px-3">
                <i class="bi bi-eraser me-1"></i>Limpiar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="col-12 col-lg-8 col-xxl-9">
      <div class="card border border-danger shadow-sm h-100">
        <div class="card-body" id="list-region">
          <div class="table-responsive">
            <h6 class="text-danger fw-bold mb-3 d-flex align-items-center">
              <i class="bi bi-box-seam-fill me-2"></i>Productos Registrados
            </h6>
            <table class="table table-hover table-striped align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>SKU</th>
                  <th>Nombre</th>
                  <th>Categor√≠a</th>
                  <th>Stock</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="list-body">
                {% for p in productos %}
                <tr>
                  <td>{{ p.id }}</td>
                  <td>{{ p.sku }}</td>
                  <td>{{ p.nombre }}</td>
                  <td>{{ p.categoria }}</td>
                  <td>{{ p.stock }}</td>
                  <td class="d-flex gap-1 justify-content-center">
                    <button class="btn btn-warning btn-sm" onclick="editarProducto('{{ p.id }}')"><i class="bi bi-pencil-square"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="eliminarProducto('{{ p.id }}')"><i class="bi bi-trash3-fill"></i></button>
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="text-center text-muted py-3">Sin resultados</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          {% if page_obj %}
          <div class="d-flex justify-content-between align-items-center border-top border-danger pt-3 mt-3">
            <small id="list-pagination-label" class="text-danger">
              Mostrando {{ page_obj.start_index }} - {{ page_obj.end_index }} de {{ page_obj.paginator.count }} productos
            </small>
            <nav id="list-pagination" aria-label="Paginaci√≥n de productos">
              <ul class="pagination pagination-sm mb-0">
                {% if page_obj.has_previous %}
                <li class="page-item"><a class="page-link border-danger text-danger" href="?page=1&q={{ query|urlencode }}&sort={{ sort_by }}">&laquo;</a></li>
                <li class="page-item"><a class="page-link border-danger text-danger" href="?page={{ page_obj.previous_page_number }}&q={{ query|urlencode }}&sort={{ sort_by }}">Anterior</a></li>
                {% endif %}
                <li class="page-item active"><span class="page-link bg-danger border-danger">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>
                {% if page_obj.has_next %}
                <li class="page-item"><a class="page-link border-danger text-danger" href="?page={{ page_obj.next_page_number }}&q={{ query|urlencode }}&sort={{ sort_by }}">Siguiente</a></li>
                <li class="page-item"><a class="page-link border-danger text-danger" href="?page={{ page_obj.paginator.num_pages }}&q={{ query|urlencode }}&sort={{ sort_by }}">&raquo;</a></li>
                {% endif %}
              </ul>
            </nav>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========== JS CRUD ========== -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  .swal-container { text-align: left !important; }
  .swal-label-input { margin-bottom: 1rem; }
  .swal-label-input label { display: block; margin-bottom: .25rem; font-size: .9rem; color: #555; }
  .swal-label-input .swal2-input, .swal-label-input .swal-custom-select { width: 100% !important; margin: 0 !important; }
  .swal-custom-select { display: block !important; padding: .375rem .75rem; font-size: 1rem; border: 1px solid #d1d1d1; border-radius: .25rem; }
</style>
<script>
/* -------- Validaci√≥n visual y CRUD del formulario principal -------- */
(function(){
  // CSRF: meta -> cookie (fallback). Sin cambiar estructura.
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const CSRF =
    document.querySelector('meta[name="csrf-token"]')?.content ||
    getCookie("csrftoken") ||
    "";

  function setInvalid(el, msg) {
    if (!el) return;
    const fb = el.parentElement.querySelector('.invalid-feedback');
    if (msg) {
      el.classList.add("is-invalid");
      if (fb) fb.textContent = msg;
    } else {
      el.classList.remove("is-invalid");
      if (fb) fb.textContent = '';
    }
  }

  function switchToTabOf(element) {
    const pane = element.closest('.tab-pane');
    if (pane && !pane.classList.contains('active')) {
      const trigger = document.querySelector(`[data-bs-target="#${pane.id}"]`);
      if (trigger) new bootstrap.Tab(trigger).show();
    }
  }

  const today = new Date().toISOString().split('T')[0];
  const ultimaEntradaEl = document.querySelector('input[name="ultima_entrada"]');
  if (ultimaEntradaEl) ultimaEntradaEl.value = today;

  function validarFormulario(form) {
    let ok = true;
    let primerError = null;
    form.querySelectorAll("input[required], select[required], textarea[required]").forEach(el => {
      const val = el.value.trim();
      const valido = val !== "" && !(el.type === "number" && isNaN(val));
      if (!valido) {
        setInvalid(el, el.parentElement.querySelector('.invalid-feedback')?.textContent || 'Este campo es obligatorio.');
        if (!primerError) primerError = el;
        ok = false;
      } else {
        setInvalid(el, null);
      }
    });

    const stockMinEl = form.querySelector('input[name="stock_min"]');
    const stockMaxEl = form.querySelector('input[name="stock_max"]');
    if (stockMinEl && stockMaxEl) {
      const stockMin = parseFloat(stockMinEl.value);
      const stockMax = parseFloat(stockMaxEl.value);
      if (!isNaN(stockMin) && !isNaN(stockMax) && stockMin > stockMax) {
        setInvalid(stockMinEl, 'El stock m√≠nimo no puede superar al m√°ximo.');
        if (!primerError) primerError = stockMinEl;
        ok = false;
      }
    }

    if (primerError) {
      switchToTabOf(primerError);
      primerError.focus();
    }
    return ok;
  }

  const form = document.getElementById("form-prod");
  if (!form) return;

  form.querySelector('input[name="sku"]')?.addEventListener('input', (e)=>{
    e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9._-]/g,'');
  });

  ['stock_min', 'stock_max', 'precio_compra', 'precio_venta'].forEach(name => {
    const input = form.querySelector(`input[name="${name}"]`);
    if (input) {
      input.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');
      });
    }
  });

  document.getElementById('btnGuardarProducto')?.addEventListener('click', async () => {
    form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    if (!validarFormulario(form)) return;

    const fd = new FormData(form);
    const payload = {
      sku:           (fd.get("sku") || "").trim(),
      nombre:        (fd.get("nombre") || "").trim(),
      categoria:     (fd.get("categoria") || "").trim(),
      descripcion:   (fd.get("descripcion") || "").trim(),
      precio_compra: (fd.get("precio_compra") || "").trim(),
      precio_venta:  (fd.get("precio_venta") || "").trim(),
      marca:         (fd.get("marca") || "").trim(),
      stock_min:     (fd.get("stock_min") || "").trim(),
      stock_max:     (fd.get("stock_max") || "").trim(),
      estado:        (fd.get("estado") || "Activo").trim(),
      ubicacion:     (fd.get("ubicacion") || "").trim(),
      uom:           (fd.get("uom") || "").trim(),
    };

    try {
      const resp = await fetch("{% url 'products:crear' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": CSRF,
          "X-Requested-With": "XMLHttpRequest"
        },
        body: JSON.stringify(payload)
      });
      const data = await resp.json();

      if (!resp.ok || !data.ok) {
        throw new Error(data.error || "Error del servidor. No se pudo crear el producto.");
      }

      await Swal.fire({icon:'success', title:'Producto creado', timer:1200, showConfirmButton:false});
      form.reset();
      location.reload();
    } catch (err) {
      console.error(err);
      Swal.fire({icon:'error', title:'Error', text: err.message || 'Error inesperado.'});
    }
  });

  document.getElementById('btnLimpiar')?.addEventListener('click', () => {
    form.reset();
    form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
  });

  // ====== EDITAR (GET con X-Requested-With y preConfirm robusto) ======
  window.editarProducto = function (id) {
    const CSRF_LOCAL =
      document.querySelector('meta[name="csrf-token"]')?.content ||
      document.cookie.split('; ').find(r => r.startsWith('csrftoken='))?.split('=')[1] ||
      '';

    fetch(`/productos/editar/${id}/`, { headers: { "X-Requested-With": "XMLHttpRequest" } })
      .then(r => { if (!r.ok) throw new Error('Error en la respuesta del servidor'); return r.json(); })
      .then(response => {
        if (!response.ok) throw new Error(response.error || 'No se pudieron cargar los datos del producto.');
        const { data } = response;
        Swal.fire({
          title: 'Editar Producto',
          html: `
            <div class="swal-label-input"><label for="edit_sku">SKU</label><input id="edit_sku" class="swal2-input" value="${data.sku || ''}" readonly style="background:#eee;"></div>
            <div class="swal-label-input"><label for="edit_nombre">Nombre</label><input id="edit_nombre" class="swal2-input" value="${data.nombre || ''}"></div>
            <div class="swal-label-input">
              <label for="edit_categoria">Categor√≠a</label>
              <select id="edit_categoria" class="swal-custom-select">
                <option value="">-- Sin Categor√≠a --</option>
                ${(data.categorias || []).map(c => `<option value="${c.id}" ${c.id == data.categoria ? 'selected' : ''}>${c.nombre}</option>`).join('')}
              </select>
            </div>
            <div class="swal-label-input"><label for="edit_marca">Marca</label><input id="edit_marca" class="swal2-input" value="${data.marca || ''}"></div>
            <div class="swal-label-input"><label for="edit_descripcion">Descripci√≥n</label><textarea id="edit_descripcion" class="swal2-textarea">${data.descripcion || ''}</textarea></div>
          `,
          showCancelButton: true,
          confirmButtonColor: '#d33',
          confirmButtonText: "Guardar",
          cancelButtonText: "Cancelar",

          preConfirm: async () => {
            try {
              const payload = {
                nombre: document.getElementById("edit_nombre").value,
                categoria: document.getElementById("edit_categoria").value,
                marca: document.getElementById("edit_marca").value,
                descripcion: document.getElementById("edit_descripcion").value,
              };

              const resp = await fetch(`/productos/editar/${id}/`, {
                method: "POST",
                headers: {
                  "X-CSRFToken": CSRF_LOCAL,
                  "Content-Type": "application/json",
                  "X-Requested-With": "XMLHttpRequest"
                },
                body: JSON.stringify(payload)
              });

              const ctype = resp.headers.get("content-type") || "";
              if (!ctype.includes("application/json")) {
                const html = await resp.text();
                throw new Error(`${resp.status} ${resp.statusText} ‚Äì Detalle: ${html.slice(0, 400)}`);
              }

              const dataResp = await resp.json();
              if (!resp.ok || !dataResp.ok) {
                throw new Error(dataResp.error || "No se pudo actualizar el producto.");
              }
              return dataResp; // √©xito

            } catch (err) {
              Swal.showValidationMessage(err.message || "Error inesperado al actualizar.");
            }
          }
        }).then(res => {
          if (res.value?.ok) {
            Swal.fire({ icon: "success", title: "Actualizado", timer: 1200, showConfirmButton: false })
              .then(() => location.reload());
          } else if (res.value) {
            Swal.fire({ icon: "error", title: "Error", text: res.value.error || 'No se pudo actualizar.' });
          }
        });
      })
      .catch(err => Swal.fire({ icon:"error", title:"Error", text: err.message || "No se pudo obtener el producto." }));
  };

  // ====== ELIMINAR (usa CSRF meta -> cookie) ======
  window.eliminarProducto = function (id){
    const CSRF_LOCAL =
      document.querySelector('meta[name="csrf-token"]')?.content ||
      document.cookie.split('; ').find(r => r.startsWith('csrftoken='))?.split('=')[1] ||
      '';
    Swal.fire({
      title:"¬øEliminar producto?",
      text:"Esta acci√≥n no se puede revertir",
      icon:"warning",
      showCancelButton:true,
      confirmButtonColor:"#d33",
      cancelButtonColor:"#3085d6",
      confirmButtonText:"S√≠, eliminar",
      cancelButtonText:"Cancelar"
    }).then(res=>{
      if(!res.isConfirmed)return;
      fetch(`/productos/eliminar/${id}/`,{
        method:"POST",
        headers:{ "X-CSRFToken": CSRF_LOCAL, "X-Requested-With": "XMLHttpRequest" }
      }).then(r=>r.json()).then(data=>{
        if(data.status==="ok"){
          Swal.fire("¬°Eliminado!",data.message,"success").then(()=>location.reload());
        }else{
          Swal.fire({icon:"error",title:"Error",text:data.message});
        }
      });
    });
  };
})();
</script>

<!-- LIVE SEARCH estilo transacciones (Enter deshabilitado) -->
<script>
(function () {
  function log(){/* console.log.apply(console, arguments); */ }

  function doFetch(url) {
    return fetch(url, {
      method: "GET",
      credentials: "same-origin",
      cache: "no-store",
      headers: { "X-Requested-With": "XMLHttpRequest" }
    }).then(r => {
      if (!r.ok) throw new Error("HTTP " + r.status);
      return r.text();
    });
  }

  function extractAndSwap(html) {
    const tmp = document.createElement("div");
    tmp.innerHTML = html;
    const nextRegion = tmp.querySelector("#list-region");
    const curRegion  = document.querySelector("#list-region");
    if (!nextRegion || !curRegion) { window.location.reload(); return; }
    curRegion.replaceWith(nextRegion);
    setupLiveSearch(document); // re-atacha eventos tras el swap
  }

  function urlFromForm(form) {
    const base = new URL(form.action || window.location.pathname, window.location.origin);
    base.search = "";
    const fd = new FormData(form);
    const q = (fd.get("q") || "").trim();

    if (q === "") {
      fd.delete("q");
    }
    for (const [k, v] of fd.entries()) {
      if (!v) continue;
      if (k === "page") continue;
      base.searchParams.set(k, v);
    }
    base.searchParams.set("page", "1");
    return base.toString();
  }

  function setupLiveSearch(root = document) {
    const searchForm  = root.querySelector('form[data-live="search"]');
    if (!searchForm) return;

    const searchInput = searchForm.querySelector('input[name="q"]');
    if (searchInput && !searchInput._liveBound) {
      let debounceTimer;
      searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => searchForm.dispatchEvent(new Event("submit", { cancelable: true })), 400);
      });
      searchInput._liveBound = true;
    }

    if (!searchForm._liveBoundSubmit) {
      searchForm.addEventListener("submit", function (ev) {
        ev.preventDefault();
        const url = urlFromForm(this);
        document.body.style.cursor = "progress";
        doFetch(url).then(html => {
          extractAndSwap(html);
          window.history.replaceState({}, "", url);
        }).catch(e => log("submit error:", e)).finally(() => { document.body.style.cursor = ""; });
      });
      searchForm._liveBoundSubmit = true;
    }

    if (!root._liveBoundPagination) {
      root.addEventListener("click", function (ev) {
        const a = ev.target.closest("#list-pagination a");
        if (!a || !a.href) return;
        ev.preventDefault();
        document.body.style.cursor = "progress";
        doFetch(a.href).then(html => {
          extractAndSwap(html);
          window.history.replaceState({}, "", a.href);
        }).catch(e => log("pag error:", e)).finally(() => { document.body.style.cursor = ""; });
      });
      root._liveBoundPagination = true;
    }
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => setupLiveSearch(document));
  } else {
    setupLiveSearch(document);
  }
})();
</script>
{% endblock %}
