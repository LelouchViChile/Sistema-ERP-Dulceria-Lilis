{% extends "base.html" %}
{% load static %}
{% block title %}Gestión de Productos | Dulcería Lilis ERP{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-md-4">

  <!-- Título -->
  <div class="d-flex align-items-center gap-2 mt-2 mb-3">
    <h4 class="m-0 text-danger fw-bold">
      <i class="bi bi-box-seam-fill me-2"></i>Gestión de Productos
    </h4>
    <div class="flex-grow-1">
      <hr class="border-top border-2 border-danger my-0" />
    </div>
  </div>

  <!-- Búsqueda / orden / export -->
  <div class="d-flex justify-content-end align-items-center mb-3 gap-2">
    <form method="get" class="d-flex gap-2">
      <div class="input-group input-group-sm shadow-sm" style="min-width: 280px;">
        <input type="text" name="q" class="form-control border-danger"
               placeholder="Buscar producto..." value="{{ query }}">
        <button type="submit" class="btn btn-danger">
          <i class="bi bi-search"></i>
        </button>
      </div>

      <select name="sort" class="form-select form-select-sm border-danger" onchange="this.form.submit()">
        <option value="id" {% if sort_by == 'id' %}selected{% endif %}>Ordenar por...</option>
        <option value="nombre" {% if sort_by == 'nombre' %}selected{% endif %}>Nombre (A-Z)</option>
        <option value="-nombre" {% if sort_by == '-nombre' %}selected{% endif %}>Nombre (Z-A)</option>
        <option value="categoria" {% if sort_by == 'categoria' %}selected{% endif %}>Categoría (A-Z)</option>
        <option value="-categoria" {% if sort_by == '-categoria' %}selected{% endif %}>Categoría (Z-A)</option>
      </select>

      <a class="btn btn-success btn-sm d-flex align-items-center shadow-sm"
         href="{% url 'products:list' %}?q={{ query }}&sort={{ sort_by }}&export=xlsx">
        <i class="bi bi-file-earmark-excel me-2"></i>Exportar
      </a>
    </form>
  </div>

  <div class="row g-3 align-items-start">
    <!-- Formulario con pestañas -->
    <div class="col-12 col-lg-4 col-xxl-3">
      <div class="card border border-danger shadow-sm h-100">
        <div class="card-body">
          <h6 class="text-danger fw-bold mb-3 d-flex align-items-center">
            <i class="bi bi-plus-circle-fill me-2"></i>Nuevo Producto
          </h6>

          <!-- Aquí se agrega 'row g-3' para estructura de columnas y espaciado uniforme -->
          <form id="form-prod" method="post" action="{% url 'products:crear' %}" class="row g-3 needs-validation" novalidate>
            {% csrf_token %}
            <!-- NAV TABS -->
            <ul class="nav nav-tabs mb-3" id="prodTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active text-danger fw-semibold" id="tab-datos" data-bs-toggle="tab"
                        data-bs-target="#pane-datos" type="button" role="tab">Datos Generales</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link text-danger fw-semibold" id="tab-inv" data-bs-toggle="tab"
                        data-bs-target="#pane-inv" type="button" role="tab">Inventario</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link text-danger fw-semibold" id="tab-img" data-bs-toggle="tab"
                        data-bs-target="#pane-img" type="button" role="tab">Multimedia</button>
              </li>
            </ul>

            <!-- CONTENIDO TABS -->
            <div class="tab-content" id="prodTabsContent">

              <!-- DATOS GENERALES -->
              <div class="tab-pane fade show active" id="pane-datos" role="tabpanel">
                <!-- Aquí agregamos row g-3 para columnas -->
                <div class="row g-3">
                  <div class="col-6">
                    <label class="form-label small mb-1">SKU</label>
                    <input type="text" name="sku" class="form-control form-control-sm" required>
                    <div class="invalid-feedback">El SKU es obligatorio.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Nombre</label>
                    <input type="text" name="nombre" class="form-control form-control-sm" required>
                    <div class="invalid-feedback">El nombre es obligatorio.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Categoría</label>
                    <select name="categoria" class="form-select form-select-sm" required>
                      <option value="">Seleccione...</option>
                      {% for cat in categorias %}
                      <option value="{{ cat.id }}">{{ cat.nombre }}</option>
                      {% endfor %}
                    </select>
                    <div class="invalid-feedback">Selecciona una categoría.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Descripción</label>
                    <textarea name="descripcion" class="form-control form-control-sm" rows="2" required></textarea>
                    <div class="invalid-feedback">La descripción es obligatoria.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Precio Compra</label>
                    <input type="number" name="precio_compra" class="form-control form-control-sm" step="0.01" min="0" required>
                    <div class="invalid-feedback">El precio de compra es obligatorio.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Precio Venta</label>
                    <input type="number" name="precio_venta" class="form-control form-control-sm" step="0.01" min="0" required>
                    <div class="invalid-feedback">El precio de venta es obligatorio.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Unidad de Medida</label>
                    <input type="text" name="unidad_medida" class="form-control form-control-sm" placeholder="Ej: kg, caja, unidad..." required>
                    <div class="invalid-feedback">La unidad de medida es obligatoria.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Marca</label>
                    <input type="text" name="marca" class="form-control form-control-sm" required>
                    <div class="invalid-feedback">La marca es obligatoria.</div>
                  </div>
                </div>
              </div>

              <!-- INVENTARIO -->
              <div class="tab-pane fade" id="pane-inv" role="tabpanel">
                <div class="row g-3">
                  <div class="col-6">
                    <label class="form-label small mb-1">Stock Mínimo</label>
                    <input type="number" name="stock_min" class="form-control form-control-sm" min="0" required>
                    <div class="invalid-feedback">El stock mínimo es obligatorio.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Stock Máximo</label>
                    <input type="number" name="stock_max" class="form-control form-control-sm" min="0" required>
                    <div class="invalid-feedback">El stock máximo es obligatorio.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Ubicación en Bodega</label>
                    <input type="text" name="ubicacion" class="form-control form-control-sm" required>
                    <div class="invalid-feedback">La ubicación es obligatoria.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Proveedor Principal</label>
                    <input type="text" name="proveedor" class="form-control form-control-sm" required>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Última Entrada</label>
                    <input type="date" name="ultima_entrada" class="form-control form-control-sm" required>
                    <div class="invalid-feedback">La fecha es obligatoria.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small mb-1">Estado</label>
                    <select name="estado" class="form-select form-select-sm" required>
                      <option value="Activo">Activo</option>
                      <option value="Inactivo">Inactivo</option>
                      <option value="Descontinuado">Descontinuado</option>
                    </select>
                    <div class="invalid-feedback">El estado es obligatorio.</div>
                  </div>
                </div>
              </div>

              <!-- MULTIMEDIA -->
              <div class="tab-pane fade" id="pane-img" role="tabpanel">
                <div class="row g-3">
                  <div class="col-12">
                    <label class="form-label small mb-1">Imagen del Producto</label>
                    <input type="file" name="imagen" class="form-control form-control-sm" required>
                    <div class="invalid-feedback">La imagen es obligatoria.</div>
                  </div>
                  <div class="col-12">
                    <label class="form-label small mb-1">Código de Barras</label>
                    <input type="text" name="codigo_barras" class="form-control form-control-sm" required>
                    <div class="invalid-feedback">El código de barras es obligatorio.</div>
                  </div>
                  <div class="col-12">
                    <label class="form-label small mb-1">Notas Internas</label>
                    <textarea name="notas" class="form-control form-control-sm" rows="2" required></textarea>
                    <div class="invalid-feedback">Las notas son obligatorias.</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-3 d-flex gap-2">
              <button type="button" id="btnGuardarProducto" class="btn btn-sm btn-danger flex-grow-1">
                <i class="bi bi-check-lg me-1"></i>Guardar
              </button>
              <button type="button" id="btnLimpiar" class="btn btn-sm btn-outline-danger px-3">
                <i class="bi bi-eraser me-1"></i>Limpiar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="col-12 col-lg-8 col-xxl-9">
      <div class="card border border-danger shadow-sm h-100">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover table-striped align-middle mb-0">
              <h6 class="text-danger fw-bold mb-3 d-flex align-items-center">
              <i class="bi bi-box-seam-fill me-2"></i>Productos Registrados
              </h6>
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>SKU</th>
                  <th>Nombre</th>
                  <th>Categoría</th>
                  <th>Stock</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for p in productos %}
                <tr>
                  <td>{{ p.id }}</td>
                  <td>{{ p.sku }}</td>
                  <td>{{ p.nombre }}</td>
                  <td>{{ p.categoria }}</td>
                  <td>{{ p.stock }}</td>
                  <td class="d-flex gap-1 justify-content-center">
                    <button class="btn btn-warning btn-sm" onclick="editarProducto('{{ p.id }}')"><i class="bi bi-pencil-square"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="eliminarProducto('{{ p.id }}')"><i class="bi bi-trash3-fill"></i></button>
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="text-center text-muted py-3">Sin resultados</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          {% if page_obj %}
          <div class="d-flex justify-content-between align-items-center border-top border-danger pt-3 mt-3">
            <small class="text-danger">
              Mostrando {{ page_obj.start_index }} - {{ page_obj.end_index }} de {{ page_obj.paginator.count }} productos
            </small>
            <nav aria-label="Paginación de productos">
              <ul class="pagination pagination-sm mb-0">
                {% if page_obj.has_previous %}
                <li class="page-item"><a class="page-link border-danger text-danger" href="?page=1&q={{ query }}&sort={{ sort_by }}">&laquo;</a></li>
                <li class="page-item"><a class="page-link border-danger text-danger" href="?page={{ page_obj.previous_page_number }}&q={{ query }}&sort={{ sort_by }}">Anterior</a></li>
                {% endif %}
                <li class="page-item active"><span class="page-link bg-danger border-danger">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>
                {% if page_obj.has_next %}
                <li class="page-item"><a class="page-link border-danger text-danger" href="?page={{ page_obj.next_page_number }}&q={{ query }}&sort={{ sort_by }}">Siguiente</a></li>
                <li class="page-item"><a class="page-link border-danger text-danger" href="?page={{ page_obj.paginator.num_pages }}&q={{ query }}&sort={{ sort_by }}">&raquo;</a></li>
                {% endif %}
              </ul>
            </nav>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========== JS CRUD ========== -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
/* -------- Validación visual en el formulario principal -------- */
(function(){
  // === Igual que Transacciones: CSRF + helpers ===
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const CSRF = getCookie("csrftoken");

  // === Helpers de validación (igual que en proveedores) ===
  function setInvalid(el, msg) {
    if (!el) return;
    const fb = el.parentElement.querySelector('.invalid-feedback');
    if (msg) {
      el.classList.add("is-invalid");
      if (fb) fb.textContent = msg;
    } else {
      el.classList.remove("is-invalid");
      if (fb) fb.textContent = ''; // Limpiar el mensaje cuando es válido
    }
  }

  function switchToTabOf(element) {
    const pane = element.closest('.tab-pane');
    if (pane && !pane.classList.contains('active')) {
      const trigger = document.querySelector(`[data-bs-target="#${pane.id}"]`);
      if (trigger) new bootstrap.Tab(trigger).show();
    }
  }

  function validarFormulario(form) {
    let ok = true;
    let primerError = null;
    form.querySelectorAll("input[required], select[required], textarea[required]").forEach(el => { // Asegurarse de que solo se validan los campos con 'required'
      const val = el.value.trim();
      const valido = val !== "" && !(el.type === "number" && isNaN(val)); // También valida números
      if (!valido) {
        setInvalid(el, el.parentElement.querySelector('.invalid-feedback')?.textContent || 'Este campo es obligatorio.');
        if (!primerError) primerError = el;
        ok = false;
      } else {
        setInvalid(el, null);
      }
    });
    if (primerError) {
      switchToTabOf(primerError);
      primerError.focus();
    }
    return ok;
  }

  const form = document.getElementById("form-prod");
  if (!form) return;

  // (Opcional) impedir caracteres raros en SKU
  form.querySelector('input[name="sku"]')?.addEventListener('input', (e)=>{
    e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9._-]/g,'');
  });

  document.getElementById('btnGuardarProducto')?.addEventListener('click', async () => {
    // Limpiar mensajes previos
    form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

    if (!validarFormulario(form)) return;

    // === Toma los valores del form (MISMO NOMBRE que en tu HTML) ===
    const fd = new FormData(form);

    // === Mapeo al payload (misma idea que Transacciones:crear) ===
    const payload = {
      sku:           (fd.get("sku") || "").trim(),
      nombre:        (fd.get("nombre") || "").trim(),
      categoria:     (fd.get("categoria") || "").trim(),
      descripcion:   (fd.get("descripcion") || "").trim(),
      precio_compra: (fd.get("precio_compra") || "").trim(),
      precio_venta:  (fd.get("precio_venta") || "").trim(),
      marca:         (fd.get("marca") || "").trim(),
      codigo_barras: (fd.get("codigo_barras") || "").trim(),
      stock_min:     (fd.get("stock_min") || "").trim(),
      stock_max:     (fd.get("stock_max") || "").trim(),
      estado:        (fd.get("estado") || "Activo").trim(),
      // Los que no existen en el modelo (imagen/ubicacion/proveedor/...) se ignoran
    };

    try {
      // === POST JSON al endpoint (igual que transacciones) ===
      const resp = await fetch("{% url 'products:crear' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": CSRF,
          "X-Requested-With": "XMLHttpRequest"
        },
        body: JSON.stringify(payload)
      });
      const data = await resp.json();

      if (!resp.ok || !data.ok) {
        throw new Error(data.error || "Error del servidor. No se pudo crear el producto.");
      }

      await Swal.fire({icon:'success', title:'Producto creado', timer:1200, showConfirmButton:false});
      // Limpieza rápida del form
      form.reset();
      // Recargar listado para ver el nuevo
      location.reload();
    } catch (err) {
      console.error(err);
      Swal.fire({icon:'error', title:'Error', text: err.message || 'Error inesperado.'});
    }
  });

  document.getElementById('btnLimpiar')?.addEventListener('click', () => {
    form.reset();
    form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
  });

  /* -------- FUNCIÓN EDITAR PRODUCTO -------- */
  function editarProducto(id) {
    fetch(`/productos/editar/${id}/`)
      .then(response => {
        if (!response.ok) throw new Error('Error en la respuesta del servidor');
        return response.json();
      })
      .then(data => {
        if (data) {
          Swal.fire({
            title: "Editar Producto",
            html:
              `<input id="edit_sku" class="swal2-input" placeholder="SKU" value="${data.sku || ''}">` +
              `<input id="edit_nombre" class="swal2-input" placeholder="Nombre" value="${data.nombre || ''}">` +
              `<select id="edit_categoria" class="swal2-input">` +
                `<option value="">-- Sin Categoría --</option>` +
                `${(data.categorias || []).map(c => `<option value="${c.id}" ${c.id == data.categoria ? 'selected' : ''}>${c.nombre}</option>`).join('')}` +
              `</select>` +
              `<input id="edit_precio_venta" class="swal2-input" placeholder="Precio Venta" value="${data.precio_venta || 0}">` +
              `<input id="edit_marca" class="swal2-input" placeholder="Marca" value="${data.marca || ''}">`,
            showCancelButton: true,
            confirmButtonText: "Guardar",
            cancelButtonText: "Cancelar",
            preConfirm: () => {
              const fd = new FormData();
              fd.append("sku", document.getElementById("edit_sku").value);
              fd.append("nombre", document.getElementById("edit_nombre").value);
              fd.append("categoria", document.getElementById("edit_categoria").value);
              fd.append("precio_venta", document.getElementById("edit_precio_venta").value);
              fd.append("marca", document.getElementById("edit_marca").value);
              return fetch(`/productos/editar/${id}/`, {
                method: "POST",
                headers: { "X-CSRFToken": CSRF }, // Usar la constante CSRF
                body: fd
              }).then(r => r.json());
            }
          }).then(res => {
            if (res.value?.status === "ok") {
              Swal.fire({ icon: "success", title: "Actualizado", timer: 1200, showConfirmButton: false })
                .then(() => location.reload());
            } else if (res.value?.status === "error") {
              Swal.fire({ icon: "error", title: "Error", text: res.value.message });
            }
          });
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire({ icon: "error", title: "Error al cargar datos", text: "No se pudo obtener la información del producto." });
      });
  }

  function eliminarProducto(id){
    Swal.fire({
      title:"¿Eliminar producto?",
      text:"Esta acción no se puede revertir",
      icon:"warning",
      showCancelButton:true,
      confirmButtonColor:"#d33",
      cancelButtonColor:"#3085d6",
      confirmButtonText:"Sí, eliminar",
      cancelButtonText:"Cancelar"
    }).then(res=>{
      if(!res.isConfirmed)return;
      fetch(`/productos/eliminar/${id}/`,{
        method:"POST",
        headers:{ "X-CSRFToken": CSRF } // Usar la constante CSRF
      }).then(r=>r.json()).then(data=>{
        if(data.status==="ok"){
          Swal.fire("¡Eliminado!",data.message,"success").then(()=>location.reload());
        }else{
          Swal.fire({icon:"error",title:"Error",text:data.message});
        }
      });
    });
  }

  // Exponer las funciones al scope global
  window.editarProducto = editarProducto;
  window.eliminarProducto = eliminarProducto;

})(); // Fin del IIFE
</script>
{% endblock %}