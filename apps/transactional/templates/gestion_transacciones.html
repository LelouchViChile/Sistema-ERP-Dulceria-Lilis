{% extends "base.html" %}
{% load static %}
{% block title %}Gesti√≥n Transacciones | Dulcer√≠a Lilis ERP{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-md-4">

  <!-- T√≠tulo -->
  <div class="d-flex align-items-center gap-2 mt-2 mb-3">
    <h4 class="m-0 text-danger fw-bold">
      <i class="bi bi-clipboard-data me-2"></i>Gesti√≥n de Transacciones
    </h4>
    <div class="flex-grow-1">
      <hr class="border-top border-2 border-danger my-0" />
    </div>
  </div>

  <!-- üîç BUSCADOR Y FILTROS -->
  <div class="d-flex justify-content-end align-items-center mb-3 gap-2">
    <form method="get" class="d-flex gap-2">
      <div class="input-group input-group-sm shadow-sm" style="min-width: 280px;">
        <input type="text" name="q" class="form-control border-danger" placeholder="Buscar movimiento..." value="{{ query }}">
        <button type="submit" class="btn btn-danger">
          <i class="bi bi-search"></i>
        </button>
      </div>

      <select name="sort" class="form-select form-select-sm border-danger" onchange="this.form.submit()">
        <option value="fecha" {% if sort_by == 'fecha' %}selected{% endif %}>Fecha</option>
        <option value="-fecha" {% if sort_by == '-fecha' %}selected{% endif %}>Fecha (desc)</option>
        <option value="tipo" {% if sort_by == 'tipo' %}selected{% endif %}>Tipo</option>
        <option value="producto" {% if sort_by == 'producto' %}selected{% endif %}>Producto</option>
      </select>

      <select name="ver" class="form-select form-select-sm border-danger" onchange="this.form.submit()">
        <option value="todos" {% if ver == 'todos' %}selected{% endif %}>Todos</option>
        <option value="ingresos" {% if ver == 'ingresos' %}selected{% endif %}>Ingresos</option>
        <option value="salidas" {% if ver == 'salidas' %}selected{% endif %}>Salidas</option>
        <option value="ajustes" {% if ver == 'ajustes' %}selected{% endif %}>Ajustes</option>
      </select>

      <a class="btn btn-success btn-sm d-flex align-items-center shadow-sm"
         href="{% url 'transactional:export_xlsx' %}?q={{ query }}&sort={{ sort_by }}&ver={{ ver }}">
        <i class="bi bi-file-earmark-excel me-2"></i>Exportar
      </a>
    </form>
  </div>

  <!-- FILAS -->
  <div class="row g-3 align-items-start">

    <!-- üìã FORMULARIO -->
    <div class="col-12 col-lg-4 col-xxl-3">
      <div class="card border border-danger shadow-sm h-100">
        <div class="card-body">
          <h6 class="text-danger fw-bold mb-3 d-flex align-items-center">
            <i class="bi bi-plus-square-fill me-2"></i>Registrar movimiento
          </h6>

          <form id="form-mov" class="needs-validation" novalidate>
            <!-- TABS -->
            <ul class="nav nav-tabs mb-3" id="movTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active text-danger fw-semibold" id="tab-datos" data-bs-toggle="tab"
                        data-bs-target="#pane-datos" type="button" role="tab">Datos</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link text-danger fw-semibold" id="tab-avanzado" data-bs-toggle="tab"
                        data-bs-target="#pane-avanzado" type="button" role="tab">Control</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link text-danger fw-semibold" id="tab-referencias" data-bs-toggle="tab"
                        data-bs-target="#pane-referencias" type="button" role="tab">Referencias</button>
              </li>
            </ul>

            <div class="tab-content" id="movTabsContent">
              <!-- TAB: DATOS -->
              <div class="tab-pane fade show active" id="pane-datos" role="tabpanel">
                <div class="row g-2">
                  <div class="col-6">
                    <label class="form-label small">Fecha</label>
                    <input id="movFecha" name="fecha" type="date" class="form-control form-control-sm" required>
                    <div class="invalid-feedback">Fecha obligatoria.</div>
                  </div>
                  <div class="col-6">
                    <label class="form-label small">Tipo</label>
                    <select id="movTipo" name="tipo" class="form-select form-select-sm" required>
                      <option value="">Seleccione...</option>
                      <option>Ingreso</option>
                      <option>Salida</option>
                      <option>Ajuste</option>
                      <option>Devoluci√≥n</option>
                      <option>Transferencia</option>
                    </select>
                    <div class="invalid-feedback">Selecciona un tipo.</div>
                  </div>

                  <div class="col-6">
                    <label class="form-label small">Producto</label>
                    <input id="movProducto" name="producto_text" type="text" class="form-control form-control-sm" required placeholder="SKU o nombre">
                    <input type="hidden" id="movProductoId" name="producto_id" value="">
                    <div class="invalid-feedback">Producto obligatorio.</div>
                  </div>

                  <div class="col-6">
                    <label class="form-label small">Proveedor</label>
                    <input id="movProveedor" name="proveedor_text" type="text" class="form-control form-control-sm" placeholder="Opcional">
                    <input type="hidden" id="movProveedorId" name="proveedor_id" value="">
                    <div class="form-text small">Requerido en Ingreso/Devoluci√≥n.</div>
                    <div class="invalid-feedback">Proveedor requerido para este tipo.</div>
                  </div>

                  <div class="col-6">
                    <label class="form-label small">Cantidad</label>
                    <input id="movCantidad" name="cantidad" type="number" class="form-control form-control-sm" step="0.01" min="0" required>
                    <div class="invalid-feedback">Cantidad ‚â• 0.</div>
                  </div>
                </div>
              </div>

              <!-- TAB: CONTROL -->
              <div class="tab-pane fade" id="pane-avanzado" role="tabpanel">
                <div class="row g-2">
                  <div class="col-6">
                    <label class="form-label small">Lote</label>
                    <input id="movLote" name="lote" type="text" class="form-control form-control-sm">
                  </div>
                  <div class="col-6">
                    <label class="form-label small">Serie</label>
                    <input id="movSerie" name="serie" type="text" class="form-control form-control-sm">
                  </div>
                  <div class="col-12">
                    <label class="form-label small">Fecha vencimiento</label>
                    <input id="movVenc" name="vencimiento" type="date" class="form-control form-control-sm">
                    <div class="form-text small">Si se informa, no puede estar vencida para Ingreso/Transferencia.</div>
                  </div>
                </div>
              </div>

              <!-- TAB: REFERENCIAS -->
              <div class="tab-pane fade" id="pane-referencias" role="tabpanel">
                <div class="row g-2">
                  <div class="col-12">
                    <label class="form-label small">Doc. Referencia</label>
                    <input id="movDoc" name="doc_ref" type="text" class="form-control form-control-sm" placeholder="DL-101">
                  </div>
                  <div class="col-12">
                    <label class="form-label small">Motivo</label>
                    <input id="movMotivo" name="motivo" type="text" class="form-control form-control-sm" placeholder="Obligatorio en Ajuste/Devoluci√≥n">
                  </div>
                  <div class="col-12">
                    <label class="form-label small">Observaciones</label>
                    <textarea id="movObs" name="observaciones" class="form-control form-control-sm" rows="2" placeholder="Notas..."></textarea>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-3 d-flex gap-2">
              <button type="submit" class="btn btn-sm btn-danger flex-grow-1">
                <i class="bi bi-check-lg me-1"></i>Guardar
              </button>
              <button type="button" id="btn-clear-mov" class="btn btn-sm btn-outline-danger px-3">
                <i class="bi bi-eraser me-1"></i>Limpiar
              </button>
            </div>
            <div id="movMsg" class="small mt-2"></div>
          </form>
        </div>
      </div>
    </div>

    <!-- üìÑ TABLA -->
    <div class="col-12 col-lg-8 col-xxl-9">
      <div class="card border border-danger shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="m-0">Movimientos</h6>
          </div>

          <div class="table-responsive" style="max-height:520px; overflow-y:auto;">
            <table class="table table-hover table-striped align-middle mb-0" id="movTable">
              <thead class="table-light">
                <tr>
                  <th>Fecha</th><th>Tipo</th><th>Folio</th><th>Producto</th><th>Proveedor</th>
                  <th>Bodega</th><th>Cantidad</th><th>Usuario</th><th>Serie</th><th>Lote</th>
                  <th>Venc.</th><th>Doc Ref</th><th>Acciones</th>
                </tr>
              </thead>
              <tbody id="movTbody">
                {% for m in movimientos %}
                <tr data-id="{{ m.folio }}">
                  <td>{{ m.fecha }}</td><td>{{ m.tipo }}</td><td>{{ m.folio }}</td><td>{{ m.producto }}</td>
                  <td>{{ m.proveedor }}</td><td>{{ m.bodega }}</td><td>{{ m.cantidad }}</td><td>{{ m.usuario }}</td>
                  <td>{{ m.serie }}</td><td>{{ m.lote }}</td><td>{{ m.venc }}</td><td>{{ m.doc_ref }}</td>
                  <td>
                    <button class="btn btn-sm btn-warning btn-edit-mov" data-id="{{ m.folio }}"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-danger btn-del-mov" data-id="{{ m.folio }}"><i class="bi bi-trash"></i></button>
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="13" class="text-center text-muted">Sin resultados</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <nav id="movPaginator" class="mt-3" aria-label="Paginaci√≥n">
            <ul class="pagination pagination-sm justify-content-center mb-0"></ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Embedded initial data for client-side renderer (if needed) -->
{{ movimientos|json_script:"movimientos-data" }}

<!-- ========== JS ========== -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <!-- opcional para confirmaciones r√°pidas -->
<script>
(function(){
  // CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const CSRF = getCookie("csrftoken");

  // Utility: debounce
  function debounce(fn, wait){
    let t;
    return function(...args){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), wait); };
  }

  // ---------- Helpers ----------
  function setInvalid(el, msg){
    if(!el) return;
    const fb = el.parentElement.querySelector('.invalid-feedback');
    if(msg){
      el.classList.add('is-invalid');
      if(fb) fb.textContent = msg;
    } else {
      el.classList.remove('is-invalid');
      if(fb) fb.textContent = '';
    }
  }

  function showMsg(el, text, ok=true){
    el.classList.remove('text-danger','text-success');
    el.classList.add(ok ? 'text-success' : 'text-danger');
    el.textContent = text;
  }

  // Clamp non-negative inputs
  document.querySelectorAll('input[data-nonneg]').forEach(el=>{
    el.addEventListener('keydown', e => { if(['-','e','E','+'].includes(e.key)) e.preventDefault(); });
    el.addEventListener('blur', ()=> { if(el.value === '' ) return; const n = Number(el.value); if(isNaN(n) || n < 0) el.value = 0; });
  });

  // --------- Validation (all tabs) ----------
  function validateForm(formEl){
    let ok = true;
    let firstError = null;

    // native required checks
    formEl.querySelectorAll("[required]").forEach(input=>{
      const val = (input.value || "").toString().trim();
      const valid = val !== "" && !(input.type === "number" && isNaN(val));
      if(!valid){
        input.classList.add("is-invalid");
        if(!firstError) firstError = input;
        ok = false;
      } else {
        input.classList.remove("is-invalid");
      }
    });

    // specific checks
    const tipo = document.getElementById("movTipo");
    const proveedor = document.getElementById("movProveedor");
    const cantidad = document.getElementById("movCantidad");
    const fecha = document.getElementById("movFecha");
    const venc = document.getElementById("movVenc");

    // cantidad >= 0
    const cnum = parseFloat(cantidad.value || "0");
    if(isNaN(cnum) || cnum < 0){ setInvalid(cantidad, "Cantidad inv√°lida."); if(!firstError) firstError = cantidad; ok=false; } else setInvalid(cantidad,null);

    // proveedor required on some types
    const t = (tipo.value || "").trim();
    if((t === "Ingreso" || t === "Devoluci√≥n") && !(proveedor.value || "").trim()){
      setInvalid(proveedor, "Proveedor requerido para este tipo.");
      if(!firstError) firstError = proveedor;
      ok = false;
    } else {
      setInvalid(proveedor, null);
    }

    // fecha not future
    const now = new Date().toISOString().slice(0,10);
    if(fecha.value && fecha.value > now){ setInvalid(fecha, "Fecha no puede ser futura."); if(!firstError) firstError = fecha; ok=false; } else setInvalid(fecha,null);

    // vencimiento validation
    if(venc.value && (t === "Ingreso" || t === "Transferencia") && venc.value < now){
      setInvalid(venc, "Fecha de vencimiento no puede estar vencida.");
      if(!firstError) firstError = venc;
      ok = false;
    } else setInvalid(venc, null);

    // focus and open tab of first error
    if(firstError){
      const tabPane = firstError.closest('.tab-pane');
      if(tabPane && !tabPane.classList.contains('active')){
        const id = tabPane.id;
        const trigger = document.querySelector(`[data-bs-target="#${id}"]`);
        if(trigger) new bootstrap.Tab(trigger).show();
      }
      firstError.focus();
    }

    return ok;
  }

  // ---------- Client-side simple paginator ----------
  const ROWS_PER_PAGE = 8;
  let currentPage = 1;
  let currentItems = []; // array of items currently displayed (from search or initial)

  function renderTableRows(items, page=1){
    const tbody = document.getElementById('movTbody');
    tbody.innerHTML = '';
    if(!items || items.length === 0){
      tbody.innerHTML = '<tr><td colspan="13" class="text-center text-muted">Sin resultados</td></tr>';
      document.getElementById('movPaginator').style.display='none';
      return;
    }
    currentItems = items;
    const start = (page-1) * ROWS_PER_PAGE;
    const paged = items.slice(start, start + ROWS_PER_PAGE);
    for(const r of paged){
      const tr = document.createElement('tr');
      tr.dataset.id = r.id ?? r.folio ?? '';
      tr.innerHTML = `
        <td>${r.fecha ?? ''}</td>
        <td>${r.tipo ?? ''}</td>
        <td>${r.folio ?? (r.id ?? '')}</td>
        <td>${r.producto ?? ''}</td>
        <td>${r.proveedor ?? ''}</td>
        <td>${r.bodega ?? ''}</td>
        <td>${r.cantidad ?? ''}</td>
        <td>${r.usuario ?? ''}</td>
        <td>${r.serie ?? ''}</td>
        <td>${r.lote ?? ''}</td>
        <td>${r.venc ?? ''}</td>
        <td>${r.doc_ref ?? ''}</td>
        <td>
          <button class="btn btn-sm btn-warning btn-edit-mov" data-id="${r.id ?? r.folio ?? ''}"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm btn-danger btn-del-mov" data-id="${r.id ?? r.folio ?? ''}"><i class="bi bi-trash"></i></button>
        </td>`;
      tbody.appendChild(tr);
    }
    renderPaginator(items.length, page);
    attachRowButtons();
  }

  function renderPaginator(totalItems, page){
    const nav = document.getElementById('movPaginator');
    const ul = nav.querySelector('ul.pagination');
    const pages = Math.ceil(totalItems / ROWS_PER_PAGE);
    ul.innerHTML = '';
    if(pages <= 1){ nav.style.display = 'none'; return; }
    nav.style.display = '';
    // previous
    const liPrev = document.createElement('li'); liPrev.className = 'page-item' + (page === 1 ? ' disabled' : '');
    liPrev.innerHTML = `<a class="page-link border-danger text-danger" href="#" aria-label="Anterior">&laquo;</a>`;
    liPrev.onclick = (e) => { e.preventDefault(); if(page>1) { currentPage = page-1; renderTableRows(currentItems, currentPage); } };
    ul.appendChild(liPrev);

    for(let i=1;i<=pages;i++){
      const li = document.createElement('li'); li.className = 'page-item' + (i === page ? ' active' : '');
      li.innerHTML = `<a class="page-link ${i===page?'bg-danger text-white border-danger':'border-danger text-danger'}" href="#">${i}</a>`;
      li.onclick = (e) => { e.preventDefault(); currentPage = i; renderTableRows(currentItems, currentPage); };
      ul.appendChild(li);
    }

    const liNext = document.createElement('li'); liNext.className = 'page-item' + (page === pages ? ' disabled' : '');
    liNext.innerHTML = `<a class="page-link border-danger text-danger" href="#" aria-label="Siguiente">&raquo;</a>`;
    liNext.onclick = (e) => { e.preventDefault(); if(page<pages) { currentPage = page+1; renderTableRows(currentItems, currentPage); } };
    ul.appendChild(liNext);
  }

  // Attach edit/delete handlers for rows after rendering
  function attachRowButtons(){
    document.querySelectorAll('.btn-edit-mov').forEach(btn=>{
      btn.removeEventListener('click', onEditClick);
      btn.addEventListener('click', onEditClick);
    });
    document.querySelectorAll('.btn-del-mov').forEach(btn=>{
      btn.removeEventListener('click', onDeleteClick);
      btn.addEventListener('click', onDeleteClick);
    });
  }

  // ---------- Initial load: take embedded data if available ----------
  let initial = [];
  try { initial = JSON.parse(document.getElementById('movimientos-data').textContent || '[]') || []; } catch(e){ initial = []; }
  // normalize initial array to objects with minimal keys if user uses demo
  const normalized = initial.map((m, idx) => ({
    id: m.id ?? m.folio ?? idx+1,
    fecha: m.fecha,
    tipo: m.tipo,
    folio: m.folio ?? (m.id ?? ''),
    producto: m.producto,
    proveedor: m.proveedor,
    bodega: m.bodega || '',
    cantidad: m.cantidad,
    usuario: m.usuario || '',
    serie: m.serie || '',
    lote: m.lote || '',
    venc: m.venc || '',
    doc_ref: m.doc_ref || ''
  }));
  renderTableRows(normalized, 1);

  // ---------- Search (AJAX) ----------
  const searchInput = document.getElementById('tx-search');
  const searchUrl = "{% url 'transactional:search' %}";
  const doSearch = debounce(async function(q){
    if(!q){ renderTableRows(normalized, 1); return; }
    try{
      const url = new URL(searchUrl, window.location.origin);
      url.searchParams.set('q', q);
      const resp = await fetch(url, { headers: {'X-Requested-With': 'XMLHttpRequest'} });
      if(!resp.ok) { renderTableRows([],1); return; }
      const data = await resp.json();
      const rows = (data.results || []).map(r => ({
        id: r.id,
        fecha: r.fecha,
        tipo: r.tipo,
        folio: r.id,
        producto: r.producto,
        proveedor: r.proveedor,
        bodega: '',
        cantidad: r.cantidad,
        usuario: '',
        serie: '',
        lote: '',
        venc: '',
        doc_ref: ''
      }));
      currentPage = 1;
      renderTableRows(rows, 1);
    }catch(e){
      renderTableRows([],1);
    }
  }, 250);

  searchInput?.addEventListener('input', (ev) => {
    doSearch(ev.target.value.trim());
  });

  // ---------- Create transaction (AJAX) ----------
  document.getElementById('form-mov')?.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const form = ev.target;
    const movMsg = document.getElementById('movMsg');
    movMsg.textContent = '';
    if(!validateForm(form)){ showMsg(movMsg, 'Revisa los campos resaltados.', false); return; }

    const payload = {
      tipo: document.getElementById('movTipo').value.trim(),
      fecha: document.getElementById('movFecha').value.trim(),
      cantidad: document.getElementById('movCantidad').value.trim(),
      producto_id: document.getElementById('movProductoId').value || null,
      proveedor_id: document.getElementById('movProveedorId').value || null,
      producto_text: document.getElementById('movProducto').value.trim(),
      proveedor_text: document.getElementById('movProveedor').value.trim(),
      lote: document.getElementById('movLote').value.trim(),
      serie: document.getElementById('movSerie').value.trim(),
      vencimiento: document.getElementById('movVenc').value.trim(),
      doc_ref: document.getElementById('movDoc').value.trim(),
      motivo: document.getElementById('movMotivo').value.trim(),
      observaciones: document.getElementById('movObs').value.trim()
    };

    try{
      const resp = await fetch("{% url 'transactional:crear' %}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF, 'X-Requested-With': 'XMLHttpRequest' },
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      if(!resp.ok || !data.ok){
        const errs = data.errors || {};
        // Map errors to fields if available
        for(const k in errs){
          const field = document.querySelector(`[name="${k}"],#${k}`);
          if(field) setInvalid(field, errs[k]);
        }
        showMsg(movMsg, errs.__all__ || 'Error al crear movimiento.', false);
        return;
      }

      // Success: add row to currentItems and re-render first page
      const newRow = {
        id: data.id ?? Date.now(),
        fecha: payload.fecha,
        tipo: payload.tipo,
        folio: data.id ?? '',
        producto: payload.producto_text || '',
        proveedor: payload.proveedor_text || '',
        bodega: '',
        cantidad: payload.cantidad,
        usuario: '{{ request.user.username|default:"" }}',
        serie: payload.serie || '',
        lote: payload.lote || '',
        venc: payload.vencimiento || '',
        doc_ref: payload.doc_ref || ''
      };
      // prepend to normalized + currentItems
      normalized.unshift(newRow);
      currentPage = 1;
      renderTableRows(normalized, 1);
      showMsg(movMsg, 'Movimiento creado correctamente.', true);
      // reset form
      form.reset();
      form.classList.remove('was-validated');
      setTimeout(()=> movMsg.textContent = '', 2000);
    }catch(e){
      console.error(e);
      showMsg(movMsg, 'Error al crear movimiento.', false);
    }
  });

  document.getElementById('btn-clear-mov')?.addEventListener('click', ()=>{
    document.getElementById('form-mov').reset();
    document.getElementById('form-mov').classList.remove('was-validated');
    document.querySelectorAll('#form-mov .is-invalid').forEach(i=>i.classList.remove('is-invalid'));
    document.getElementById('movMsg').textContent = '';
  });

  // ---------- Edit / Delete handlers ----------
  async function onEditClick(e){
    const id = e.currentTarget.dataset.id;
    if(!id) return;
    // GET data
    try{
      const resp = await fetch(`{% url 'transactional:editar' 0 %}`.replace('/0/', `/${id}/`), { headers: {'X-Requested-With': 'XMLHttpRequest'} });
      if(!resp.ok) throw new Error('No se pudo obtener movimiento');
      const data = await resp.json();
      if(!data.ok) throw new Error(data.error || 'Error');
      // fill modal
      document.getElementById('editMovId').value = data.movimiento.id;
      document.getElementById('editFecha').value = data.movimiento.fecha ? data.movimiento.fecha.split('T')[0] : '';
      document.getElementById('editTipo').value = data.movimiento.tipo || '';
      document.getElementById('editCantidad').value = data.movimiento.cantidad ?? '';
      // show modal
      const modal = new bootstrap.Modal(document.getElementById('editMovModal'));
      modal.show();
    }catch(err){
      console.error(err);
      Swal.fire({ icon:'error', title:'Error', text: err.message || 'No se pudo obtener movimiento.' });
    }
  }

  document.getElementById('form-edit-mov')?.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const id = document.getElementById('editMovId').value;
    const tipo = document.getElementById('editTipo').value;
    const fecha = document.getElementById('editFecha').value;
    const cantidad = document.getElementById('editCantidad').value;
    // basic validate
    if(!tipo || !fecha || cantidad === '' || Number.isNaN(Number(cantidad))) {
      Swal.fire({ icon:'error', title:'Error', text:'Revisa los campos.' });
      return;
    }
    try{
      const resp = await fetch(`{% url 'transactional:editar' 0 %}`.replace('/0/', `/${id}/`), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF, 'X-Requested-With': 'XMLHttpRequest' },
        body: JSON.stringify({ tipo, fecha, cantidad })
      });
      const data = await resp.json();
      if(!resp.ok || !data.ok){
        Swal.fire({ icon:'error', title:'Error', text: data.error || 'No se pudo actualizar.' });
        return;
      }
      // update row in normalized/currentItems if present
      for(const arr of [normalized, currentItems]){
        const idx = arr.findIndex(x => String(x.id) === String(id) || String(x.folio) === String(id));
        if(idx !== -1){
          arr[idx].tipo = tipo;
          arr[idx].fecha = fecha;
          arr[idx].cantidad = cantidad;
        }
      }
      renderTableRows(currentItems.length ? currentItems : normalized, currentPage);
      const modalEl = document.getElementById('editMovModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal?.hide();
      Swal.fire({ icon:'success', title:'Actualizado', timer:1000, showConfirmButton:false });
    }catch(err){
      console.error(err);
      Swal.fire({ icon:'error', title:'Error', text:'No se pudo actualizar.' });
    }
  });

  async function onDeleteClick(e){
    const id = e.currentTarget.dataset.id;
    if(!id) return;
    const res = await Swal.fire({
      title: '¬øEliminar movimiento?',
      text: 'Esta acci√≥n no se puede revertir',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'S√≠, eliminar',
      cancelButtonText: 'Cancelar'
    });
    if(!res.isConfirmed) return;
    try{
      const resp = await fetch(`{% url 'transactional:eliminar' 0 %}`.replace('/0/', `/${id}/`), {
        method: 'POST',
        headers: { 'X-CSRFToken': CSRF, 'X-Requested-With': 'XMLHttpRequest' }
      });
      const data = await resp.json();
      if(!resp.ok || !data.ok){
        Swal.fire({ icon:'error', title:'Error', text: data.error || 'No se pudo eliminar.' });
        return;
      }
      // remove from arrays
      for(const arr of [normalized, currentItems]){
        const idx = arr.findIndex(x => String(x.id) === String(id) || String(x.folio) === String(id));
        if(idx !== -1) arr.splice(idx, 1);
      }
      renderTableRows(currentItems.length ? currentItems : normalized, 1);
      Swal.fire({ icon:'success', title:'Eliminado', timer:1000, showConfirmButton:false });
    }catch(err){
      console.error(err);
      Swal.fire({ icon:'error', title:'Error', text:'No se pudo eliminar.' });
    }
  }

  // wire initial row buttons (for server-rendered rows)
  attachRowButtons();

})();
</script>
{% endblock %}